---
import { getCollection, type CollectionEntry } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import CATEGORIES from '../../components/Categories.astro';
import { getCategoryHreflang } from '../../data/hreflang';
export async function getStaticPaths() {
  const allGames = await getCollection('games');
  // 只使用英文 canonical 游戏作为分类基准，避免各语言版本重复出现在分类列表中
  const canonicalGames = allGames.filter((game) => game.data.locale === 'en');
  const getCanonicalSlug = (entry: CollectionEntry<'games'>): string =>
    String(entry.data.urlstr || entry.slug).replace(/^\/+/, '').replace(/\/+$/, '');
  const normalizeTag = (tag: string): string => tag.trim().toLowerCase();
  // Minimal slugify: convert spaces to hyphens (tags already normalized)
  const slugify = (normalizedTag: string): string => normalizedTag.replace(/\s+/g, '-');
  const toTagSlug = (rawTag: string): string => slugify(normalizeTag(rawTag));

  // Use slug as the route key to avoid collisions like "2 player" vs "2-player".
  const uniqueSlugs = [
    ...new Set(
      canonicalGames
        .flatMap((game) => game.data.tags || [])
        .filter((tag): tag is string => typeof tag === 'string' && tag.trim() !== '')
        .map((tag) => toTagSlug(tag))
    ),
  ].sort();

  return uniqueSlugs.map((slug) => {
    // Filter games that include the current tag.
    const filteredGames = canonicalGames.filter((game) =>
      (game.data.tags || []).some(
        (rawTag) => typeof rawTag === 'string' && toTagSlug(rawTag) === slug
      )
    );

    // Deterministic sort: releaseDate desc, then slug asc (avoid unstable ordering on ties).
    filteredGames.sort((a, b) => {
      const dateA = a.data.releaseDate ? a.data.releaseDate.getTime() : 0;
      const dateB = b.data.releaseDate ? b.data.releaseDate.getTime() : 0;
      const byDate = dateB - dateA;
      if (byDate !== 0) return byDate;
      return getCanonicalSlug(a).localeCompare(getCanonicalSlug(b));
    });

    return {
      params: { slug }, // Use slugified tag in URL
      props: { games: filteredGames, tagName: slug.replace(/-/g, ' ') }, // Normalized tag for display
    };
  });
}

type Props = {
  games: CollectionEntry<'games'>[];
  tagName: string;
};

const { games, tagName } = Astro.props as Props;
const slug = Astro.params.slug!;
const hreflangLinks = getCategoryHreflang(slug);

// 规范化展示用的分类名称（首字母大写）
const displayTagName = tagName
  .split(' ')
  .map((word) => word.charAt(0).toUpperCase() + word.slice(1))
  .join(' ');

// Generate SEO-friendly description
const gameCount = games.length;
const description = `Play ${gameCount} ${displayTagName} games online for free. Discover the best ${displayTagName} games including ${games
  .slice(0, 3)
  .map((g) => g.data.title.split(' - ')[0])
  .join(', ')} and more!`;

const title = `${displayTagName} Games - FiddleBops Game World`;
const canonicalUrl = `https://www.playfiddlebops.com/c/${slug}/`;

const jsonLd = {
  '@context': 'https://schema.org',
  '@type': 'ItemList',
  name: title,
  description,
  url: canonicalUrl,
  itemListElement: games.map((game, index) => ({
    '@type': 'ListItem',
    position: index + 1,
    url: `https://www.playfiddlebops.com/${game.data.urlstr ?? game.slug}/`
  }))
};

---

<BaseLayout
  title={title}
  description={description}
  canonicalUrl={canonicalUrl}
  jsonLd={jsonLd}
  hreflangLinks={hreflangLinks}
  lang="en"
>
  <section class="games">
    <div class="container">
      <h1>{displayTagName} Games</h1>
      <p>
        Play {gameCount} {displayTagName} games online for free. Discover top picks and more.
      </p>
      <div class="game-grid">
        {games.map((game) => {
          const url = `/${game.data.urlstr ?? game.slug}/`;
          const gameTitle = game.data.title.split(' - ')[0];
          return (
            <article class="game">
              <a href={url}>
                <div class="game-logo">
                  <img
                    src={game.data.thumbnail}
                    alt={gameTitle}
                    loading="lazy"
                    width="300"
                    height="300"
                  />
                </div>
                <p>{gameTitle}</p>
              </a>
            </article>
          );
        })}
      </div>
    </div>
  </section>

  <CATEGORIES lang="en" />
</BaseLayout>
