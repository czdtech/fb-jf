---
import BaseLayout from '../../layouts/BaseLayout.astro';
import CATEGORIES from '../../components/Categories.astro';
import { getCategoryHreflang } from '../../data/hreflang';
import { getCanonicalGames, toGameCardData, type GameEntry } from '../../lib/canonical-games';
export async function getStaticPaths() {
  // 只使用英文 canonical 游戏作为分类基准，避免各语言版本重复出现在分类列表中
  const canonicalGames = await getCanonicalGames();
  const getCanonicalSlug = (entry: GameEntry): string =>
    String(entry.data.urlstr || entry.slug).replace(/^\/+/, '').replace(/\/+$/, '');
  const normalizeTag = (tag: string): string => tag.trim().toLowerCase();
  // Minimal slugify: convert spaces to hyphens (tags already normalized)
  const slugify = (normalizedTag: string): string => normalizedTag.replace(/\s+/g, '-');
  const toTagSlug = (rawTag: string): string => slugify(normalizeTag(rawTag));

  // ✅ Taxonomy 策略（B）：只为“核心分类”生成 /c/<slug>/ 页面，避免 200+ tag 产生大量薄内容页。
  // 其它 tags 仅用于关键词/推荐/搜索，不生成分类页（访问会 404）。
  const CORE_CATEGORY_SLUGS = [
    'puzzle',
    'casual',
    'thinky',
    'action',
    'sports',
    'strategy',
    'platformer',
    'arcade',
    'shooting',
    'card',
    'rhythm',
    'adventure',
    'music',
    'clicker',
    'driving',
    'physics',
    'multiplayer',
    '2-player',
  ] as const;

  const paths = CORE_CATEGORY_SLUGS.map((slug) => {
    // Filter games that include the current tag slug.
    const filteredGames = canonicalGames.filter((game) =>
      (game.data.tags || []).some((rawTag) => typeof rawTag === 'string' && toTagSlug(rawTag) === slug)
    );

    // Deterministic sort: releaseDate desc, then slug asc (avoid unstable ordering on ties).
    filteredGames.sort((a, b) => {
      const dateA = a.data.releaseDate ? a.data.releaseDate.getTime() : 0;
      const dateB = b.data.releaseDate ? b.data.releaseDate.getTime() : 0;
      const byDate = dateB - dateA;
      if (byDate !== 0) return byDate;
      return getCanonicalSlug(a).localeCompare(getCanonicalSlug(b));
    });

    return {
      params: { slug }, // Use slugified tag in URL
      props: { games: filteredGames, tagName: slug.replace(/-/g, ' ') }, // Normalized tag for display
    };
  }).filter((p) => (p.props.games?.length ?? 0) > 0);

  return paths;
}

type Props = {
  games: GameEntry[];
  tagName: string;
};

const { games, tagName } = Astro.props as Props;
const locale = 'en';
const slug = Astro.params.slug!;
const hreflangLinks = getCategoryHreflang(slug);

// 规范化展示用的分类名称（首字母大写）
const displayTagName = tagName
  .split(' ')
  .map((word) => word.charAt(0).toUpperCase() + word.slice(1))
  .join(' ');

// Generate SEO-friendly description
const gameCount = games.length;
const description = `Play ${gameCount} ${displayTagName} games online for free. Discover the best ${displayTagName} games including ${games
  .slice(0, 3)
  .map((g) => toGameCardData(g, locale).title)
  .join(', ')} and more!`;

const title = `${displayTagName} Games - FiddleBops Game World`;
const canonicalUrl = `https://www.playfiddlebops.com/c/${slug}/`;

const jsonLd = {
  '@context': 'https://schema.org',
  '@type': 'ItemList',
  name: title,
  description,
  url: canonicalUrl,
  itemListElement: games.map((game, index) => {
    const card = toGameCardData(game, locale);
    return {
      '@type': 'ListItem',
      position: index + 1,
      url: `https://www.playfiddlebops.com${card.href}`,
    };
  }),
};

---

<BaseLayout
  title={title}
  description={description}
  canonicalUrl={canonicalUrl}
  jsonLd={jsonLd}
  hreflangLinks={hreflangLinks}
  lang="en"
>
  <section class="games">
    <div class="container">
      <h1>{displayTagName} Games</h1>
      <p>
        Play {gameCount} {displayTagName} games online for free. Discover top picks and more.
      </p>
      <div class="game-grid">
        {games.map((game) => {
          const card = toGameCardData(game, locale);
          return (
            <article class="game">
              <a href={card.href}>
                <div class="game-logo">
                  <img
                    src={card.thumbnail}
                    alt={card.title}
                    loading="lazy"
                    width="300"
                    height="300"
                  />
                </div>
                <p>{card.title}</p>
              </a>
            </article>
          );
        })}
      </div>
    </div>
  </section>

  <CATEGORIES lang="en" />
</BaseLayout>
