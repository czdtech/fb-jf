---
/**
 * Dynamic Game Page using Content Collection
 * Refactored to use GameLayout component
 * 
 * Requirements: 2.4 - Uses GameLayout component with correct props
 */
import { getCollection, type CollectionEntry } from 'astro:content';
import GameLayout from '../layouts/GameLayout.astro';
import { getGameHreflang } from '../data/hreflang';

type Props = {
  game: CollectionEntry<'games'>;
};

export async function getStaticPaths() {
  const allGames = await getCollection('games');

  // Build a lookup map: slug -> { en: game, fr: game, ... }
  // This avoids O(N) scans in each localized page.
  const slugToLocaleMap = new Map<string, Record<string, CollectionEntry<'games'>>>();

  for (const game of allGames) {
    const slug = game.data.urlstr ?? game.slug;
    const locale = game.data.locale ?? 'en';

    if (!slugToLocaleMap.has(slug)) {
      slugToLocaleMap.set(slug, {});
    }
    slugToLocaleMap.get(slug)![locale] = game;
  }

  // 仅使用英文内容作为 canonical 路由的数据源。
  // 其它语言版本通过 locale 字段区分，不单独生成新的 slug。
  const paths = allGames
    .filter((game) => game.data.locale === 'en')
    .map((game) => {
      const legacySlug = game.data.urlstr ?? game.slug;

      return {
        params: {
          gameSlug: legacySlug,
        },
        props: {
          game,
          // Pre-computed locale map for this slug, used by localized pages
          localeMap: slugToLocaleMap.get(legacySlug) ?? { en: game },
        },
      };
    });

  return paths;
}

const { game } = Astro.props as Props;
const legacySlug = game.data.urlstr ?? game.slug;
const canonicalUrl = `https://www.playfiddlebops.com/${legacySlug}/`;
const hreflangLinks = getGameHreflang(legacySlug);

const { title, seoTitle, description, iframeSrc, tags, thumbnail, score } = game.data;
const { Content } = await game.render();
---

<GameLayout
  title={title}
  seoTitle={seoTitle}
  description={description}
  canonicalUrl={canonicalUrl}
  thumbnail={thumbnail}
  iframeSrc={iframeSrc}
  score={score}
  tags={tags}
  slug={legacySlug}
  lang="en"
  hreflangLinks={hreflangLinks}
>
  <Content />
</GameLayout>
