---
import BaseLayout from '@/layouts/BaseLayout.astro';
import Navigation from '@/components/Navigation.astro';
import Footer from '@/components/Footer.astro';
import GamesList from '@/components/GamesList.astro';
import { getTranslation } from '@/i18n/utils';
import { getLocalizedGamesList, extractBaseSlug } from '@/utils/i18n';
import type { SupportedLocale } from '@/i18n/types';

// 导入数据
import extractedData from '@/data/extracted-data.json';
const { navigation } = extractedData;

// 使用Astro官方i18n系统 - 复用首页成功模式
const currentLocale: SupportedLocale = (Astro.currentLocale as SupportedLocale) || 'en';
const { ui } = await getTranslation(currentLocale);

// 获取本地化的游戏集合 - 使用统一的错误处理
let localizedGames: any[] = [];
try {
  localizedGames = await getLocalizedGamesList(currentLocale);
  if (!localizedGames || localizedGames.length === 0) {
    localizedGames = await getLocalizedGamesList('en');
  }
} catch (error) {
  console.error(`[es/trending-games] Failed to load games for locale ${currentLocale}:`, error);
  try {
    localizedGames = await getLocalizedGamesList('en');
  } catch (fallbackError) {
    console.error('Failed to load fallback English games:', fallbackError);
    localizedGames = [];
  }
}

// 定义趋势游戏的 slug 列表（基于原始页面）
const trendingGameSlugs = [
  'ayocs-sprunkr',
  'dandyrunki-retake',
  'fiddlebops-but-dandys-world',
  'fiddlebops-but-sprunki',
  'fiddlebops-polos',
  'fiddlebops-sprunkbop',
  'fiddlebops-sprunki',
  'fiddlebops-fix'
];

// 筛选趋势游戏 - 使用统一的游戏筛选逻辑，提取基础slug进行匹配
const trendingGames = localizedGames.filter((game: any) => {
  const baseSlug = extractBaseSlug(game.data.slug);
  return game.data.category === 'trending' && trendingGameSlugs.includes(baseSlug);
});

// SEO配置
const meta = {
  title: ui.sections?.trendingGames ? `${ui.sections.trendingGames} - Fiddlebops` : 'Trending Games - Fiddlebops',
  description: ui.sections?.trendingGames ? `${ui.sections.trendingGames} - 热门 Fiddlebops 游戏` : 'Trending Games - Fiddlebops'
};
---

<BaseLayout 
  title={meta.title}
  description={meta.description}
  currentLocale={currentLocale}
>
  <Navigation 
    navigation={navigation.main} 
    currentLocale={currentLocale}
  />
  
  <main class="main">
    <div class="container">
      <h1 class="page-title">
        {ui.sections?.trendingGames || 'Trending Games'}
      </h1>
      
      <GamesList 
        games={trendingGames}
        currentLocale={currentLocale}
      />
    </div>
  </main>
  
  <Footer currentLocale={currentLocale} />
</BaseLayout>

<style>
.main {
  padding: 2rem 0;
  min-height: 70vh;
}

.container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 0 1rem;
}

.page-title {
  font-size: 2.5rem;
  font-weight: 700;
  text-align: center;
  margin-bottom: 3rem;
  color: var(--text-primary);
}

@media (max-width: 768px) {
  .page-title {
    font-size: 2rem;
    margin-bottom: 2rem;
  }
}
</style>