---
import BaseLayout from '@/layouts/BaseLayout.astro';
import Navigation from '@/components/Navigation.astro';
import Footer from '@/components/Footer.astro';
import GamesList from '@/components/GamesList.astro';
import Pagination from '@/components/Pagination.astro';
import { getTranslation } from '@/i18n/utils';
import { getLocalizedGamesList } from '@/utils/i18n';
import type { SupportedLocale } from '@/i18n/types';

// 导入数据
import extractedData from '@/data/extracted-data.json';
const { navigation } = extractedData;

// 使用Astro官方i18n系统 - 复用首页成功模式
const currentLocale: SupportedLocale = (Astro.currentLocale as SupportedLocale) || 'en';
const { ui } = await getTranslation(currentLocale);

// 获取本地化的游戏集合 - 使用统一的错误处理
let localizedGames: any[] = [];
try {
  localizedGames = await getLocalizedGamesList(currentLocale);
  if (!localizedGames || localizedGames.length === 0) {
    localizedGames = await getLocalizedGamesList('en');
  }
} catch (error) {
  console.error(`[es/popular-games] Failed to load games for locale ${currentLocale}:`, error);
  try {
    localizedGames = await getLocalizedGamesList('en');
  } catch (fallbackError) {
    console.error('Failed to load fallback English games:', fallbackError);
    localizedGames = [];
  }
}

// 获取URL参数中的页码
const url = new URL(Astro.request.url);
const currentPage = parseInt(url.searchParams.get('page') || '1', 10);
const gamesPerPage = 12;

// 筛选流行游戏 - 显示所有popular分类的游戏
const allPopularGames = localizedGames.filter((game: any) => {
  if (!game || !game.data || !game.data.slug) {
    console.warn('Invalid game object found:', game);
    return false;
  }
  return game.data.category === 'popular';
});

// 计算分页
const totalGames = allPopularGames.length;
const totalPages = Math.ceil(totalGames / gamesPerPage);
const startIndex = (currentPage - 1) * gamesPerPage;
const endIndex = startIndex + gamesPerPage;
const displayGames = allPopularGames.slice(startIndex, endIndex);

// SEO配置
const meta = {
  title: ui.sections?.popularGames ? `${ui.sections.popularGames} - Fiddlebops` : 'Popular Games - Fiddlebops',
  description: '最受欢迎的 Fiddlebops 游戏合集'
};
---

<BaseLayout 
  title={meta.title}
  description={meta.description}
  currentLocale={currentLocale}
>
  <Navigation 
    navigation={navigation.main} 
    currentLocale={currentLocale}
  />
  
  <main class="main">
    <div class="container">
      <h1 class="page-title">
        {ui.sections?.popularGames || 'Popular Games'}
      </h1>
      
      <GamesList 
        games={displayGames}
        currentLocale={currentLocale}
      />
      
      <Pagination 
        currentPage={currentPage}
        totalPages={totalPages}
        basePath="/popular-games"
        currentLocale={currentLocale}
      />
    </div>
  </main>
  
  <Footer currentLocale={currentLocale} />
</BaseLayout>

<style>
.main {
  padding: 2rem 0;
  min-height: 70vh;
}

.container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 0 1rem;
}

.page-title {
  font-size: 2.5rem;
  font-weight: 700;
  text-align: center;
  margin-bottom: 3rem;
  color: var(--text-primary);
}

@media (max-width: 768px) {
  .page-title {
    font-size: 2rem;
    margin-bottom: 2rem;
  }
}
</style>