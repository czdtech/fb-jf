---
import { getCollection } from 'astro:content';
import BaseLayout from '@/layouts/BaseLayout.astro';
import Navigation from '@/components/Navigation.astro';
import Footer from '@/components/Footer.astro';
import GamesHero from '@/components/games/GamesHero.astro';
import GameFilters from '@/components/games/GameFilters.astro';
import GameGrid from '@/components/GameGrid.astro';
import UnifiedPagination from '@/components/UnifiedPagination.astro';
import { generateHreflangLinks } from '@/utils/hreflang';
import { filterGamesByLanguage, calculatePagination } from '@/utils/content';
import { getTranslation } from '@/i18n/utils';
import type { SupportedLocale } from '@/i18n/utils';
import { PAGINATION_CONFIG } from '@/config/pagination';

// 导入数据
import extractedData from '@/data/extracted-data.json';

// --- 当前语言配置 ---
const currentLocale: SupportedLocale = 'ja';

// --- 环境变量 ---
const SITE_URL = (import.meta.env.PUBLIC_SITE_URL || 'https://www.playfiddlebops.com').replace(/\/$/, '');

// --- 类型定义 ---
interface GamePageItem {
  slug: string;
  url: string;
  imageUrl: string;
  title: string;
  category: string;
  rating: number;
  description: string;
  iframe: string;
}

interface Language {
  code: string;
  url: string;
  label: string;
}

// --- 静态路径生成 ---
export async function getStaticPaths() {
  // 获取所有游戏
  const allGames = await getCollection('games');
  
  // 使用统一工具获取日语游戏
  const jaGames = filterGamesByLanguage(allGames, 'ja');
  
  const formattedGames: GamePageItem[] = jaGames.map((game: any) => {
    // 生成正确的本地化URL路径，移除语言前缀
    const baseSlug = game.data.slug.replace(/^ja-/, '');
    
    return {
      slug: baseSlug,
      url: `/ja/${baseSlug}/`,
      imageUrl: game.data.image,
      title: game.data.title,
      category: game.data.category,
      rating: game.data.rating?.score || 5,
      description: game.data.description,
      iframe: game.data.iframe,
    };
  });

  const pageSize = PAGINATION_CONFIG.GAMES_PER_PAGE;
  const totalGames = formattedGames.length;
  const totalPages = Math.ceil(totalGames / pageSize);

  const paths = [];

  // 生成所有页面路径
  for (let i = 1; i <= totalPages; i++) {
    const startIndex = (i - 1) * pageSize;
    const endIndex = startIndex + pageSize;
    const currentGames = formattedGames.slice(startIndex, endIndex);

    paths.push({
      params: { page: i === 1 ? undefined : i.toString() },
      props: {
        page: {
          data: currentGames,
          currentPage: i,
          lastPage: totalPages,
          total: totalGames,
          start: startIndex,
          url: {
            prev: i > 1 ? (i === 2 ? `/ja/games/` : `/ja/games/${i - 1}/`) : undefined,
            next: i < totalPages ? `/ja/games/${i + 1}/` : undefined
          }
        },
        allGames: formattedGames
      },
    });
  }

  return paths;
}

// --- 页面属性 ---
const { page, allGames } = Astro.props as {
  page: {
    data: GamePageItem[];
    currentPage: number;
    lastPage: number;
    total: number;
    start: number;
    url: {
      prev?: string;
      next?: string;
    };
  };
  allGames: GamePageItem[];
};

// --- 从extractedData中获取导航数据 ---
const { navigation } = extractedData;

// 获取翻译内容
const translation = await getTranslation(currentLocale);
const uiText = translation.ui;

// --- 从extractedData中获取游戏分类 ---
const categories = [
  { name: uiText?.sections?.allGames || 'すべてのゲーム', count: allGames.length, active: true },
  { name: uiText?.sections?.popularGames || '人気', count: allGames.filter(g => g.category === 'popular').length, active: false },
  { name: uiText?.sections?.newGames || '新作', count: allGames.filter(g => g.category === 'new').length, active: false },
  { name: uiText?.sections?.trendingGames || 'トレンディング', count: allGames.filter(g => g.category === 'trending').length, active: false },
];

// --- 多语言链接 ---
const languages: Language[] = [
  { code: 'en', url: '/games/', label: 'English' },
  { code: 'zh', url: '/zh/games/', label: '简体中文' },
  { code: 'es', url: '/es/games/', label: 'Español' },
  { code: 'fr', url: '/fr/games/', label: 'Français' },
  { code: 'de', url: '/de/games/', label: 'Deutsch' },
  { code: 'ja', url: '/ja/games/', label: '日本語' },
  { code: 'ko', url: '/ko/games/', label: '한국어' }
];

const hreflangLinks = generateHreflangLinks(languages, SITE_URL);

// --- SEO元数据 ---
const pageTitle = page.currentPage === 1 
  ? `${uiText?.sections?.allGames || 'すべてのゲーム'} - Fiddlebops`
  : `${uiText?.sections?.allGames || 'すべてのゲーム'} - ${uiText?.common?.page || 'ページ'} ${page.currentPage} - Fiddlebops`;

const meta = {
  title: pageTitle,
  description: `${uiText?.sections?.allGames || 'すべての'} Fiddlebops ${uiText?.sections?.games || 'ゲーム'}を探索してください。${uiText?.common?.page || 'ページ'} ${page.currentPage} / ${page.lastPage}`,
  canonical: page.currentPage === 1 ? `${SITE_URL}/ja/games/` : `${SITE_URL}/ja/games/${page.currentPage}/`,
  ogImage: `${SITE_URL}/tw.jpg`,
  prevUrl: page.url.prev ? `${SITE_URL}${page.url.prev}` : undefined,
  nextUrl: page.url.next ? `${SITE_URL}${page.url.next}` : undefined
};

// --- 结构化数据 ---
const structuredData = {
  "@context": "https://schema.org",
  "@type": "CollectionPage",
  "name": meta.title,
  "description": meta.description,
  "url": meta.canonical,
  "numberOfItems": page.total,
  "hasPart": page.data.map(game => ({
    "@type": "Game",
    "name": game.title,
    "url": `${SITE_URL}${game.url}`,
    "image": `${SITE_URL}${game.imageUrl}`,
    "genre": game.category
  }))
};
---

<BaseLayout
  meta={meta}
  hreflang={hreflangLinks}
  structuredData={structuredData}
>
  <Navigation
    navigation={navigation.main}
    currentLocale={currentLocale}
  />
  
  <main class="min-h-screen">
    <GamesHero
      pageTotal={page.total}
      pageCount={page.lastPage}
      breadcrumbs={{ home: uiText?.common?.home || 'ホーム', current: uiText?.sections?.allGames || 'すべてのゲーム' }}
      title={{ main: uiText?.sections?.all || 'すべての', accent: uiText?.sections?.games || 'ゲーム' }}
      subtitle={`${page.total} ${uiText?.meta?.description || '素晴らしい'} Fiddlebops ${uiText?.sections?.games || 'ゲーム'}`}
    />
    
    <section class="container mx-auto px-4 py-8">
      <GameFilters categories={categories} />
      
      <GameGrid games={page.data.map((g: any) => ({ 
        id: g.slug, 
        slug: g.slug, 
        title: g.title, 
        description: g.description || '', 
        image: g.imageUrl, 
        iframe: g.iframe || '', 
        category: g.category || 'popular', 
        meta: { 
          title: g.title, 
          description: g.description || '', 
          canonical: g.url, 
          ogImage: g.imageUrl 
        } 
      }))} variant="standard" />
      
      <UnifiedPagination
        currentPage={page.currentPage}
        totalPages={page.lastPage}
        basePath="/ja/games"
      />
    </section>
  </main>
  
  <Footer currentLocale={currentLocale} />
</BaseLayout>

<style>
.container {
  max-width: 1200px;
}
</style>