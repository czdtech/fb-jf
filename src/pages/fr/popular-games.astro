---
import BaseLayout from '@/layouts/BaseLayout.astro';
import Navigation from '@/components/Navigation.astro';
import Footer from '@/components/Footer.astro';
import GamesList from '@/components/GamesList.astro';
import { getTranslation } from '@/i18n/utils';
import { getLocalizedGamesList, extractBaseSlug } from '@/utils/i18n';
import type { SupportedLocale } from '@/i18n/types';

// 导入数据
import extractedData from '@/data/extracted-data.json';
const { navigation } = extractedData;

// 使用Astro官方i18n系统 - 复用首页成功模式
const currentLocale: SupportedLocale = (Astro.currentLocale as SupportedLocale) || 'en';
const { ui } = await getTranslation(currentLocale);

// 获取本地化的游戏集合 - 使用统一的错误处理
let localizedGames: any[] = [];
try {
  localizedGames = await getLocalizedGamesList(currentLocale);
  if (!localizedGames || localizedGames.length === 0) {
    localizedGames = await getLocalizedGamesList('en');
  }
} catch (error) {
  console.error(`[fr/popular-games] Failed to load games for locale ${currentLocale}:`, error);
  try {
    localizedGames = await getLocalizedGamesList('en');
  } catch (fallbackError) {
    console.error('Failed to load fallback English games:', fallbackError);
    localizedGames = [];
  }
}

// 定义流行游戏的 slug 列表（基于原始页面）
const popularGameSlugs = [
  'sprunki-red-sun',
  'sprunki-abgerny',
  'sprunki-sonic'
];

// 筛选流行游戏 - 使用统一的游戏筛选逻辑，提取基础slug进行匹配
const popularGames = localizedGames.filter((game: any) => {
  const baseSlug = extractBaseSlug(game.data.slug);
  return game.data.category === 'popular' && popularGameSlugs.includes(baseSlug);
});

// 添加 fiddlebops 主游戏
const fiddlebopsGame = {
  slug: '',
  data: {
    title: ui.hero?.title || 'Fiddlebops',
    image: '/tw.jpg',
    category: 'Music',
    description: ui.hero?.subtitle || '创造惊人的音乐！'
  }
};

const displayGames = [...popularGames, fiddlebopsGame];

// SEO配置
const meta = {
  title: ui.sections?.popularGames ? `${ui.sections.popularGames} - Fiddlebops` : 'Popular Games - Fiddlebops',
  description: '最受欢迎的 Fiddlebops 游戏合集'
};
---

<BaseLayout 
  title={meta.title}
  description={meta.description}
  currentLocale={currentLocale}
>
  <Navigation 
    navigation={navigation.main} 
    currentLocale={currentLocale}
  />
  
  <main class="main">
    <div class="container">
      <h1 class="page-title">
        {ui.sections?.popularGames || 'Popular Games'}
      </h1>
      
      <GamesList 
        games={displayGames}
        currentLocale={currentLocale}
      />
    </div>
  </main>
  
  <Footer currentLocale={currentLocale} />
</BaseLayout>

<style>
.main {
  padding: 2rem 0;
  min-height: 70vh;
}

.container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 0 1rem;
}

.page-title {
  font-size: 2.5rem;
  font-weight: 700;
  text-align: center;
  margin-bottom: 3rem;
  color: var(--text-primary);
}

@media (max-width: 768px) {
  .page-title {
    font-size: 2rem;
    margin-bottom: 2rem;
  }
}
</style>