---
import { getCollection } from 'astro:content';
import BaseLayout from '@/layouts/BaseLayout.astro';
import Navigation from '@/components/Navigation.astro';
import Footer from '@/components/Footer.astro';
import GamesList from '@/components/GamesList.astro';
import UnifiedPagination from '@/components/UnifiedPagination.astro';
import EmptyState from '@/components/EmptyState.astro';
import GameErrorBoundary from '@/components/GameErrorBoundary.astro';
import { getTranslation } from '@/i18n/utils';
import type { SupportedLocale } from '@/i18n/utils';
import { PAGINATION_CONFIG } from '@/config/pagination';
import { generateSEOPagination } from '@/utils/pagination';
import { getRelativeLocaleUrl } from 'astro:i18n';
import { filterGamesByLanguage, filterGamesByCategory, getPaginatedGames, validateGameData } from '@/utils/content';

// 导入数据
import extractedData from '@/data/extracted-data.json';
const { navigation } = extractedData;

// 当前语言
const currentLocale: SupportedLocale = 'fr';

export async function getStaticPaths() {
  const GAME_CATEGORIES = {
    POPULAR: 'popular',
    TRENDING: 'trending', 
    NEW: 'new',
  };
  
  const categories = [
    { slug: 'popular-games', category: GAME_CATEGORIES.POPULAR },
    { slug: 'trending-games', category: GAME_CATEGORIES.TRENDING },
    { slug: 'new-games', category: GAME_CATEGORIES.NEW }
  ];

  const paths = [];

  for (const { slug, category } of categories) {
    try {
      const allGames = await getCollection('games');
      const frGames = filterGamesByLanguage(allGames, 'fr');
      const categoryGames = filterGamesByCategory(frGames, category);
      const validGames = categoryGames.filter(validateGameData);
      
      const paginationData = getPaginatedGames(validGames);
      const totalPages = Math.max(1, paginationData.totalPages);

      for (let page = 1; page <= totalPages; page++) {
        const pageData = getPaginatedGames(validGames, page);
        
        paths.push({
          params: { 
            category: slug, 
            page: page === 1 ? undefined : page.toString()
          },
          props: {
            locale: 'fr',
            category,
            slug,
            pageNumber: page,
            allGames: pageData.games,
            totalGames: pageData.totalItems,
            paginationData: pageData
          }
        });
      }
    } catch (error) {
      if (import.meta.env.DEV) {
        console.error(`Error generating fr paths for ${slug}:`, error);
      }
    }
  }

  return paths;
}

interface Props {
  locale: SupportedLocale;
  category: string;
  slug: string;
  pageNumber: number;
  allGames: any[];
  totalGames: number;
  paginationData: any;
}

const { locale, category, slug, pageNumber, allGames, totalGames, paginationData } = Astro.props;
const { ui } = await getTranslation(currentLocale);

const paginationResult = {
  games: allGames,
  currentPage: paginationData.currentPage,
  totalPages: paginationData.totalPages,
  totalItems: paginationData.totalItems,
  isEmpty: paginationData.isEmpty
};

const getCategoryTitle = (category: string) => {
  switch (category) {
    case 'popular':
      return ui.sections?.popularGames || 'Jeux Populaires';
    case 'trending':
      return ui.sections?.trendingGames || 'Jeux Tendance';
    case 'new':
      return ui.sections?.newGames || 'Nouveaux Jeux';
    default:
      return 'Jeux';
  }
};

const categoryTitle = getCategoryTitle(category);
const seoUrls = generateSEOPagination(`/${slug}`, pageNumber, paginationResult.totalPages, currentLocale);

const meta = {
  title: pageNumber === 1 
    ? `${categoryTitle} - Fiddlebops`
    : `${categoryTitle} - Page ${pageNumber} - Fiddlebops`,
  description: `${categoryTitle} - ${pageNumber === 1 ? '' : `Page ${pageNumber} - `}Fiddlebops`,
  canonical: seoUrls.canonical,
  keywords: `${categoryTitle.toLowerCase()}, fiddlebops, jeux musicaux, incredibox`,
  ogImage: 'https://www.playfiddlebops.com/tw.jpg',
  prevUrl: seoUrls.prev,
  nextUrl: seoUrls.next
};
---

<BaseLayout meta={meta} lang={currentLocale}>
  <Navigation navigation={navigation.main} currentLocale={currentLocale} />
  
  <main class="main">
    <div class="container">
      <h1 class="page-title">{categoryTitle}</h1>
      
      {paginationResult.isEmpty ? (
        <EmptyState 
          category={category}
          title={`Aucun ${categoryTitle} trouvé`}
          description={`Il n'y a actuellement aucun ${categoryTitle.toLowerCase()} disponible. Revenez plus tard ou explorez d'autres catégories.`}
          backButtonText="Voir Tous les Jeux"
          backButtonUrl={getRelativeLocaleUrl(currentLocale, '/games/')}
        />
      ) : (
        <>
          <GamesList games={paginationResult.games} currentLocale={currentLocale} />
          
          {paginationResult.totalPages > 1 && (
            <UnifiedPagination 
              currentPage={paginationResult.currentPage}
              totalPages={paginationResult.totalPages}
              basePath={`/${slug}`}
              currentLocale={currentLocale}
              variant="standard"
            />
          )}
        </>
      )}
    </div>
  </main>
  
  <Footer currentLocale={currentLocale} />
</BaseLayout>

<style>
.main { padding: 2rem 0; min-height: 70vh; }
.container { max-width: 1200px; margin: 0 auto; padding: 0 1rem; }
.page-title { font-size: 2.5rem; font-weight: 700; text-align: center; margin-bottom: 3rem; color: var(--text-primary); }
@media (max-width: 768px) { .page-title { font-size: 2rem; margin-bottom: 2rem; } }
</style>
