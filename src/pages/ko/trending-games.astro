---
import BaseLayout from '@/layouts/BaseLayout.astro';
import Navigation from '@/components/Navigation.astro';
import Footer from '@/components/Footer.astro';
import GamesList from '@/components/GamesList.astro';
import Pagination from '@/components/Pagination.astro';
import { getTranslation } from '@/i18n/utils';
import { getLocalizedGamesList } from '@/utils/i18n';
import type { SupportedLocale } from '@/i18n/types';

// Import centralized utilities
import { GAME_CATEGORIES } from '@/config/pagination';
import { 
  validatePageNumber, 
  calculatePagination, 
  filterGamesByCategory 
} from '@/utils/pagination';

// 导入数据
import extractedData from '@/data/extracted-data.json';
const { navigation } = extractedData;

// 使用Astro官方i18n系统 - 复用首页成功模式
const currentLocale: SupportedLocale = (Astro.currentLocale as SupportedLocale) || 'en';
const { ui } = await getTranslation(currentLocale);

// 获取本地化的游戏集合 - 使用统一的错误处理
let localizedGames: any[] = [];
try {
  localizedGames = await getLocalizedGamesList(currentLocale);
  if (!localizedGames || localizedGames.length === 0) {
    localizedGames = await getLocalizedGamesList('en');
  }
} catch (error) {
  console.error(`Failed to load games for locale ${currentLocale}:`, error);
  try {
    localizedGames = await getLocalizedGamesList('en');
  } catch (fallbackError) {
    console.error('Failed to load fallback English games:', fallbackError);
    localizedGames = [];
  }
}

// 获取URL参数中的页码 - 使用验证函数
const currentPage = validatePageNumber(Astro.url.searchParams.get('page'));

// 筛选趋势游戏 - 使用工具函数
const allTrendingGames = filterGamesByCategory(localizedGames, GAME_CATEGORIES.TRENDING);

// 计算分页 - 使用工具函数
const paginationResult = calculatePagination(allTrendingGames, currentPage);

// SEO配置
const meta = {
  title: ui.sections?.trendingGames ? `${ui.sections.trendingGames} - Fiddlebops` : 'Trending Games - Fiddlebops',
  description: ui.sections?.trendingGames ? `${ui.sections.trendingGames} - 热门 Fiddlebops 游戏` : 'Trending Games - Fiddlebops'
};
---

<BaseLayout 
  title={meta.title}
  description={meta.description}
  currentLocale={currentLocale}
>
  <Navigation 
    navigation={navigation.main} 
    currentLocale={currentLocale}
  />
  
  <main class="main">
    <div class="container">
      <h1 class="page-title">
        {ui.sections?.trendingGames || 'Trending Games'}
      </h1>
      
      <GamesList 
        games={paginationResult.games}
        currentLocale={currentLocale}
      />
      
      <Pagination 
        currentPage={paginationResult.currentPage}
        totalPages={paginationResult.totalPages}
        basePath="/ko/trending-games"
        currentLocale={currentLocale}
      />
    </div>
  </main>
  
  <Footer currentLocale={currentLocale} />
</BaseLayout>

<style>
.main {
  padding: 2rem 0;
  min-height: 70vh;
}

.container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 0 1rem;
}

.page-title {
  font-size: 2.5rem;
  font-weight: 700;
  text-align: center;
  margin-bottom: 3rem;
  color: var(--text-primary);
}

@media (max-width: 768px) {
  .page-title {
    font-size: 2rem;
    margin-bottom: 2rem;
  }
}
</style>