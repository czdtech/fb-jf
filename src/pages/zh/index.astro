---
import BaseLayout from '@/layouts/BaseLayout.astro'
import Navigation from '@/components/Navigation.astro'
import Footer from '@/components/Footer.astro'
import HeroSectionNew from '@/components/sections/HeroSectionNew.astro'
import HowToPlaySection from '@/components/sections/HowToPlaySection.astro'
import AboutSection from '@/components/sections/AboutSection.astro'
import SoundSamplesSection from '@/components/sections/SoundSamplesSection.astro'
import VideosSection from '@/components/sections/VideosSection.astro'
import FAQSection from '@/components/sections/FAQSection.astro'

import { getCollection } from 'astro:content';
import { getTranslation, LOCALE_NAMES } from '@/i18n/utils';
import { getLocalizedGamesList } from '@/utils/i18n';
import type { SupportedLocale } from '@/i18n/utils';
import { getAbsoluteLocaleUrl } from 'astro:i18n';
import { generateHomeHreflangLinks } from '@/utils/hreflang';
import extractedData from '@/data/extracted-data.json'

const lang: SupportedLocale = 'zh';

// UI 翻译
const translation = await getTranslation(lang);
const uiText = translation.ui;

// 获取本地化的游戏集合（优先中文版本，自动fallback到英文）
const localizedGames = await getLocalizedGamesList(lang);
const popularGames = localizedGames.filter((game: any) => game.data.category === 'popular').slice(0, 5);
const newGames = localizedGames.filter((game: any) => game.data.category === 'new').slice(0, 5);
const trendingGames = localizedGames.filter((game: any) => game.data.category === 'trending').slice(0, 10);

const games = {
  popular: popularGames.map((g: any) => ({ slug: g.slug, ...g.data })),
  new: newGames.map((g: any) => ({ slug: g.slug, ...g.data })),
  trending: trendingGames.map((g: any) => ({ slug: g.slug, ...g.data })),
};

// hreflang
const SITE_URL = (import.meta.env.PUBLIC_SITE_URL || 'https://www.playfiddlebops.com').replace(/\/$/, '');
const languages = Object.entries(LOCALE_NAMES).map(([code, label]) => ({ code, label, url: '' }));
const hreflangLinks = generateHomeHreflangLinks(languages as any, SITE_URL);

// meta
const pageMeta = {
  title: uiText?.meta?.title || 'FiddleBops - 免费在线音乐创作游戏',
  description: uiText?.meta?.description || '用 FiddleBops 创作你的专属音乐！',
  keywords: uiText?.meta?.keywords || 'fiddlebops, 音乐游戏, 音乐创作',
  canonical: getAbsoluteLocaleUrl(lang, '/'),
  ogImage: 'https://www.playfiddlebops.com/images/fiddlebops-og.jpg'
};

// 结构化数据（与英文首页一致）
const websiteNode = {
  '@type': 'WebSite',
  name: pageMeta.title,
  alternateName: 'playfiddlebops.com',
  url: pageMeta.canonical,
  description: pageMeta.description,
};
const structuredData = {
  '@context': 'https://schema.org',
  '@graph': [websiteNode],
};
---

<BaseLayout meta={pageMeta} lang={lang} hreflang={hreflangLinks} structuredData={structuredData}>
  <Navigation locale={lang} currentPath={`/${lang}/`} />
  <main id="main-content" class="min-h-screen" role="main">
    <HeroSectionNew
      hero={{
        title: uiText?.hero?.title || '用 FiddleBops 创作精彩音乐',
        description: uiText?.hero?.subtitle || '互动式音乐创作，角色丰富，创意无限',
        mainGame: {
          iframe: 'https://fiddlebops.netlify.app/',
          backgroundImage: '/tw.jpg'
        }
      }}
      games={games}
    />

    <HowToPlaySection />
    <AboutSection />
    <SoundSamplesSection soundSamples={[]}/>
    <VideosSection />
    <FAQSection />
  </main>
  <Footer locale={lang} />
</BaseLayout>
