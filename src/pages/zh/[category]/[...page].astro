---
import { getCollection } from 'astro:content';
import BaseLayout from '@/layouts/BaseLayout.astro';
import Navigation from '@/components/Navigation.astro';
import Footer from '@/components/Footer.astro';
import GamesList from '@/components/GamesList.astro';
import UnifiedPagination from '@/components/UnifiedPagination.astro';
import EmptyState from '@/components/EmptyState.astro';
import GameErrorBoundary from '@/components/GameErrorBoundary.astro';
import { getTranslation } from '@/i18n/utils';
import type { SupportedLocale } from '@/i18n/types';
import { PAGINATION_CONFIG } from '@/config/pagination';
import { generateSEOPagination } from '@/utils/pagination';
import { filterGamesByLanguage, filterGamesByCategory, getPaginatedGames, validateGameData } from '@/utils/content';

// 导入数据
import extractedData from '@/data/extracted-data.json';
const { navigation } = extractedData;

// 当前语言
const currentLocale: SupportedLocale = 'zh';

export async function getStaticPaths() {
  const GAME_CATEGORIES = {
    POPULAR: 'popular',
    TRENDING: 'trending', 
    NEW: 'new',
  };
  
  const categories = [
    { slug: 'popular-games', category: GAME_CATEGORIES.POPULAR },
    { slug: 'trending-games', category: GAME_CATEGORIES.TRENDING },
    { slug: 'new-games', category: GAME_CATEGORIES.NEW }
  ];

  const paths = [];

  for (const { slug, category } of categories) {
    try {
      // 获取所有游戏，然后过滤中文游戏和分类
      const allGames = await getCollection('games');
      const zhGames = filterGamesByLanguage(allGames, 'zh');
      const categoryGames = filterGamesByCategory(zhGames, category);
      const validGames = categoryGames.filter(validateGameData);
      
      // 使用统一工具获取分页信息
      const paginationData = getPaginatedGames(validGames);
      const totalPages = Math.max(1, paginationData.totalPages);

      // 生成中文路径
      for (let page = 1; page <= totalPages; page++) {
        // 获取特定页面的数据
        const pageData = getPaginatedGames(validGames, page);
        
        paths.push({
          params: { 
            category: slug, 
            page: page === 1 ? undefined : page.toString()
          },
          props: {
            locale: 'zh',
            category,
            slug,
            pageNumber: page,
            allGames: pageData.games,
            totalGames: pageData.totalItems,
            paginationData: pageData
          }
        });
      }
    } catch (error) {
      console.error(`Error generating zh paths for ${slug}:`, error);
    }
  }

  return paths;
}

interface Props {
  locale: SupportedLocale;
  category: string;
  slug: string;
  pageNumber: number;
  allGames: any[];
  totalGames: number;
  paginationData: any;
}

const { locale, category, slug, pageNumber, allGames, totalGames, paginationData } = Astro.props;

// 获取翻译
const { ui } = await getTranslation(currentLocale);

// 使用传入的分页数据
const paginationResult = {
  games: allGames,
  currentPage: paginationData.currentPage,
  totalPages: paginationData.totalPages,
  totalItems: paginationData.totalItems,
  isEmpty: paginationData.isEmpty
};

// 获取分类标题
const getCategoryTitle = (category: string) => {
  switch (category) {
    case 'popular':
      return ui.sections?.popularGames || '热门游戏';
    case 'trending':
      return ui.sections?.trendingGames || '趋势游戏';
    case 'new':
      return ui.sections?.newGames || '新游戏';
    default:
      return '游戏';
  }
};

const categoryTitle = getCategoryTitle(category);

// 生成 SEO 分页元数据
const seoUrls = generateSEOPagination(`/${slug}`, pageNumber, paginationResult.totalPages, currentLocale);

// 调试信息（开发环境）
if (import.meta.env.DEV) {
  console.log(`[zh/${slug}] currentLocale: ${currentLocale}`);
  console.log(`[zh/${slug}] totalGames: ${totalGames}`);
  console.log(`[zh/${slug}] pageNumber: ${pageNumber}`);
  console.log(`[zh/${slug}] currentPage: ${paginationResult.currentPage}`);
  console.log(`[zh/${slug}] totalPages: ${paginationResult.totalPages}`);
}

// SEO配置
const meta = {
  title: pageNumber === 1 
    ? `${categoryTitle} - Fiddlebops`
    : `${categoryTitle} - 第${pageNumber}页 - Fiddlebops`,
  description: `${categoryTitle} - ${pageNumber === 1 ? '' : `第${pageNumber}页 - `}Fiddlebops`,
  canonical: seoUrls.canonical,
  keywords: `${categoryTitle}, fiddlebops, 音乐游戏, incredibox`,
  ogImage: 'https://www.playfiddlebops.com/tw.jpg',
  prevUrl: seoUrls.prev,
  nextUrl: seoUrls.next
};
---

<BaseLayout 
  meta={meta}
  lang={currentLocale}
>
  <Navigation 
    navigation={navigation.main} 
    currentLocale={currentLocale}
  />
  
  <main class="main">
    <div class="container">
      <h1 class="page-title">
        {categoryTitle}
      </h1>
      
      {paginationResult.isEmpty ? (
        <EmptyState 
          category={category}
          title={`没有找到${categoryTitle}`}
          description={`目前没有可用的${categoryTitle.toLowerCase()}。请稍后再查看或浏览其他分类。`}
          backButtonText="浏览所有游戏"
          backButtonUrl="/zh/games/"
        />
      ) : (
        <>
          <GamesList 
            games={paginationResult.games}
            currentLocale={currentLocale}
          />
          
          {paginationResult.totalPages > 1 && (
            <UnifiedPagination 
              currentPage={paginationResult.currentPage}
              totalPages={paginationResult.totalPages}
              basePath={`/${slug}`}
              currentLocale={currentLocale}
              variant="standard"
            />
          )}
        </>
      )}
    </div>
  </main>
  
  <Footer currentLocale={currentLocale} />
</BaseLayout>

<style>
.main {
  padding: 2rem 0;
  min-height: 70vh;
}

.container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 0 1rem;
}

.page-title {
  font-size: 2.5rem;
  font-weight: 700;
  text-align: center;
  margin-bottom: 3rem;
  color: var(--text-primary);
}

@media (max-width: 768px) {
  .page-title {
    font-size: 2rem;
    margin-bottom: 2rem;
  }
}
</style>