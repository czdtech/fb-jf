---
import { getCollection } from 'astro:content';
import BaseLayout from '@/layouts/BaseLayout.astro';
import Navigation from '@/components/Navigation.astro';
import Footer from '@/components/Footer.astro';
import GamesHero from '@/components/games/GamesHero.astro';
import GameFilters from '@/components/games/GameFilters.astro';
import GameGrid from '@/components/GameGrid.astro';
import UnifiedPagination from '@/components/UnifiedPagination.astro';
import { generateHreflangLinks } from '@/utils/hreflang';
import { getLocalizedGamesList } from '@/utils/i18n';
import { getTranslation } from '@/i18n/utils';
import type { SupportedLocale } from '@/i18n/utils';
import { PAGINATION_CONFIG } from '@/config/pagination';
import UrlService from '@/utils/url-service';

// å¯¼å…¥æ•°æ®
import extractedData from '@/data/extracted-data.json';

// --- ç¯å¢ƒå˜é‡ ---
const SITE_URL = Astro.site.toString().replace(/\/$/, '');

// --- å½“å‰è¯­è¨€é…ç½®ï¼ˆè‹±æ–‡é»˜è®¤ï¼‰ ---
const currentLocale: SupportedLocale = 'en';

// --- ç±»å‹å®šä¹‰ ---
interface GamePageItem {
  slug: string;
  url: string;
  imageUrl: string;
  title: string;
  category: string;
  rating: number;
  description: string;
  iframe: string;
}

// --- é™æ€è·¯å¾„ç”Ÿæˆ ---
export async function getStaticPaths() {
  // ç›´æ¥åœ¨å‡½æ•°å†…å®šä¹‰å½“å‰è¯­è¨€
  const locale: SupportedLocale = 'en';
  
  // è·å–è‹±æ–‡æ¸¸æˆåˆ—è¡¨
  const localizedGames = await getLocalizedGamesList(locale);
  
  // æ ¼å¼åŒ–æ¸¸æˆæ•°æ®
  const formattedGames: GamePageItem[] = localizedGames.map((game: any) => {
    const normalizedData = UrlService.normalizeGameData(game);
    const baseSlug = normalizedData.baseSlug;
    
    return {
      slug: baseSlug,
      url: `/${baseSlug}/`, // è‹±æ–‡æ¸¸æˆæ— è¯­è¨€å‰ç¼€
      imageUrl: game.data.image,
      title: game.data.title,
      category: game.data.category,
      rating: game.data.rating?.score || 5,
      description: game.data.description,
      iframe: game.data.iframe,
    };
  });

  const totalGames = formattedGames.length;
  const totalPages = Math.ceil(totalGames / PAGINATION_CONFIG.GAMES_PER_PAGE);

  const paths: Array<{
    params: { page?: string };
    props: {
      page: {
        data: GamePageItem[];
        currentPage: number;
        lastPage: number;
        total: number;
        start: number;
        url: {
          prev?: string;
          next?: string;
        };
      };
      allGames: GamePageItem[];
      locale: string;
    };
  }> = [];

  // ä¸ºè‹±æ–‡ç”Ÿæˆæ‰€æœ‰åˆ†é¡µè·¯å¾„
  for (let i = 1; i <= totalPages; i++) {
    const startIndex = (i - 1) * PAGINATION_CONFIG.GAMES_PER_PAGE;
    const endIndex = startIndex + PAGINATION_CONFIG.GAMES_PER_PAGE;
    const currentPageGames = formattedGames.slice(startIndex, endIndex);

    paths.push({
      params: {
        page: i === 1 ? undefined : i.toString()
      },
      props: {
        page: {
          data: currentPageGames,
          currentPage: i,
          lastPage: totalPages,
          total: totalGames,
          start: startIndex,
          url: {
            prev: i > 1 ? (i === 2 ? `/games/` : `/games/${i - 1}/`) : undefined,
            next: i < totalPages ? `/games/${i + 1}/` : undefined
          }
        },
        allGames: formattedGames,
        locale: locale
      },
    });
  }

  console.log(`ğŸ“Š Generated ${totalPages} English pages with ${totalGames} games for /games/`);
  return paths;
}

// --- é¡µé¢å±æ€§ ---
const { page, allGames, locale } = Astro.props as {
  page: {
    data: GamePageItem[];
    currentPage: number;
    lastPage: number;
    total: number;
    start: number;
    url: {
      prev?: string;
      next?: string;
    };
  };
  allGames: GamePageItem[];
  locale: string;
};

console.log(`ğŸ” Processing English games page: /games/, page: ${page.currentPage}`);

// è·å–è‹±æ–‡ç¿»è¯‘
const translation = await getTranslation(currentLocale);
const ui = translation.ui || {};

// --- ä»extractedDataä¸­è·å–å¯¼èˆªæ•°æ® ---
const { navigation } = extractedData;

// --- ä»extractedDataä¸­è·å–æ¸¸æˆåˆ†ç±» ---
const categories = [
  { name: ui.navigation?.allGames || 'All Games', count: allGames.length, active: true },
  { name: 'Music', count: allGames.filter(g => g.category === 'Music').length, active: false },
  { name: 'Rhythm', count: allGames.filter(g => g.category === 'Rhythm').length, active: false },
  { name: 'Creative', count: allGames.filter(g => g.category === 'Creative').length, active: false },
];

// --- å¤šè¯­è¨€é…ç½®ï¼ˆç»Ÿä¸€ä½¿ç”¨å·¥å…·å‡½æ•°ç”Ÿæˆï¼‰ ---
const currentPath = `/games${page.currentPage > 1 ? `/${page.currentPage}` : ''}/`;

const hreflangLinks = generateHreflangLinks(
  navigation?.languages || [],
  `/games${page.currentPage > 1 ? `/${page.currentPage}` : ''}/`,
  SITE_URL
);

// --- SEOé…ç½® ---
const pageTitle = page.currentPage === 1
  ? (ui.meta?.title || "All Music Creation Games - Fiddlebops")
  : `Music Games - Page ${page.currentPage} - Fiddlebops`;

const pageDescription = page.currentPage === 1
  ? (ui.meta?.description || "Explore our complete collection of music creation games. Play Fiddlebops, Sprunki, and more innovative rhythm games online for free.")
  : `Browse page ${page.currentPage} of our music creation games collection. Discover new Fiddlebops and Sprunki games to play online.`;

const meta = {
  title: pageTitle,
  description: pageDescription,
  keywords: ui.meta?.keywords || `music games, rhythm games, fiddlebops, sprunki, online games, free games${page.currentPage > 1 ? `, page ${page.currentPage}` : ''}`,
  canonical: `${SITE_URL}${currentPath}`,
  ogImage: `${SITE_URL}/tw.jpg`,
  prevUrl: page.url.prev ? `${SITE_URL}${page.url.prev}` : undefined,
  nextUrl: page.url.next ? `${SITE_URL}${page.url.next}` : undefined
};

// --- ç»“æ„åŒ–æ•°æ® ---
const structuredData = {
  "@context": "https://schema.org",
  "@type": "CollectionPage",
  "name": meta.title,
  "description": meta.description,
  "url": meta.canonical,
  "numberOfItems": page.total,
  "hasPart": page.data.map(game => ({
    "@type": "Game",
    "name": game.title,
    "url": `${SITE_URL}${game.url}`,
    "image": `${SITE_URL}${game.imageUrl}`,
    "genre": game.category
  }))
};

// æ¸¸æˆå±•ç¤ºæ•°æ®æ ¼å¼åŒ–
const displayGames = page.data.map((g: any) => ({ 
  id: g.slug, 
  slug: g.slug, 
  title: g.title, 
  description: g.description || '', 
  image: g.imageUrl, 
  iframe: g.iframe || '', 
  category: g.category || 'popular', 
  meta: { 
    title: g.title, 
    description: g.description || '', 
    canonical: g.url, 
    ogImage: g.imageUrl 
  } 
}));
---

<BaseLayout
  meta={meta}
  hreflang={hreflangLinks}
  structuredData={structuredData}
  lang={currentLocale}
>
  <Navigation
    navigation={navigation.main}
    languages={navigation.languages}
    currentLang={currentLocale}
    currentPath={currentPath}
  />

  <main>
    <!-- Hero Section -->
    <GamesHero
      pageTotal={page.total}
      pageCount={page.lastPage}
      breadcrumbs={{ 
        home: ui.navigation?.home || 'Home', 
        current: ui.navigation?.allGames || 'All Games' 
      }}
      title={{ 
        main: 'All', 
        accent: ui.navigation?.games || 'Games' 
      }}
      subtitle={ui.hero?.subtitle || `${page.total} amazing music creation experiences`}
    />

    <!-- Games Grid -->
    <section class="py-16 bg-gray-50 min-h-[60vh]">
      <div class="responsive-container container-standard">
        <!-- Game Filters -->
        <GameFilters categories={categories} totalGames={allGames.length} />

        <!-- Results Info -->
        <div class="mb-8 text-center results-info">
          <p class="text-sm text-gray-600">
            Showing {page.start + 1}-{Math.min(page.start + page.data.length, page.total)} of {page.total} games
          </p>
        </div>

        <!-- Games Grid -->
        <GameGrid games={displayGames} variant="standard" />

        <!-- Pagination -->
        <UnifiedPagination
          currentPage={page.currentPage}
          totalPages={page.lastPage}
          totalItems={page.total}
          basePath="/games"
          variant="games"
        />
      </div>
    </section>
  </main>

  <Footer />
</BaseLayout>