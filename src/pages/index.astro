---
import BaseLayout from '@/layouts/BaseLayout.astro'
import Header from '@/components/Header.astro'
import Footer from '@/components/Footer.astro'

// 导入Section组件
import HeroSection from '@/components/sections/HeroSection.astro'
import HowToPlaySection from '@/components/sections/HowToPlaySection.astro'
import AboutSection from '@/components/sections/AboutSection.astro'
import SoundSamplesSection from '@/components/sections/SoundSamplesSection.astro'
import VideosSection from '@/components/sections/VideosSection.astro'
import FAQSection from '@/components/sections/FAQSection.astro'

// Hero设计系统已整合至 components.css

// 导入数据
import { getCollection } from 'astro:content';
import extractedData from '@/data/extracted-data.json'

const { navigation, homepage } = extractedData

// Fetch all games and filter them by category
const allGames = await getCollection('games');
const popularGames = allGames.filter(game => game.data.category === 'popular').slice(0, 5);
const newGames = allGames.filter(game => game.data.category === 'new').slice(0, 5);
const trendingGames = allGames.filter(game => game.data.category === 'trending').slice(0, 10);

const games = {
  popular: popularGames.map(g => ({ slug: g.slug, ...g.data })),
  new: newGames.map(g => ({ slug: g.slug, ...g.data })),
  trending: trendingGames.map(g => ({ slug: g.slug, ...g.data })),
};

// 多语言配置
const hreflangLinks = navigation.languages.map((lang: any) => ({
  code: lang.code === 'en' ? 'x-default' : lang.code,
  url: `https://www.playfiddlebops.com${lang.url}`,
  label: lang.label,
}))

// 结构化数据
const structuredData = {
  '@context': 'https://schema.org',
  '@type': 'Game',
  name: homepage.meta.title,
  alternateName: 'playfiddlebops.com',
  url: homepage.meta.canonical,
  description: homepage.meta.description,
}
---

<BaseLayout
  meta={homepage.meta}
  lang="en"
  hreflang={hreflangLinks}
  structuredData={structuredData}
>
  <Header
    navigation={navigation.main}
    languages={navigation.languages}
    currentLang="en"
    currentPath="/"
  />

  <main>
    <!-- Hero Section -->
    <HeroSection hero={homepage.hero} games={games} />

    <!-- How to Play Section -->
    <HowToPlaySection />

    <!-- About Section -->
    <AboutSection />

    <!-- Sound Samples Section -->
    <SoundSamplesSection soundSamples={homepage.soundSamples} />

    <!-- Video Section -->
    <VideosSection />

    <!-- FAQ Section -->
    <FAQSection />

  </main>

  <Footer />
</BaseLayout>

<!-- 引入交互系统 -->
<script>
  import '@/scripts/interactions.js'
</script>

<!-- 音频播放器脚本 - 已模块化，使用统一的音频管理器 -->
<script>
  import '@/scripts/sound-sample-player.js'
</script>

<!-- 音符点击动画 - 已模块化，使用统一的音符动画模块 -->
<script>
  import { musicNotesAnimation } from '@/scripts/music-notes-animation.js'

  document.addEventListener('DOMContentLoaded', function () {
    // 点击事件监听（带节流）- 全局音符效果
    let lastClick = 0
    document.body.addEventListener('click', function (e) {
      const now = Date.now()
      if (now - lastClick < 200) return
      lastClick = now

      // 使用模块化的音符动画
      musicNotesAnimation.createClickAnimation(e, {
        noteCount: Math.floor(Math.random() * 3) + 1,
        staggerDelay: 100,
        duration: 1200
      })
    })
  })
</script>

<style>
  /* ==========================================================================
   首页特定样式 - 基于新设计系统
   ========================================================================== */

  /* ==========================================================================
   统一页面背景
   ========================================================================== */

  body {
    /* 应用Hero背景设计到整个页面 */
    background: var(--hero-main-bg);
    min-height: 100vh;
    position: relative;
  }

  body::before {
    /* 页面级装饰纹理 */
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--hero-texture-bg);
    opacity: var(--hero-texture-opacity);
    pointer-events: none;
    z-index: -1;
  }

  /* ==========================================================================
   简洁响应式设计 - 游戏网站专用
   ========================================================================== */

  /* 防止字体加载跳动 */
  * {
    font-display: swap;
  }

  /* 图片预设尺寸防止布局偏移 */
  img {
    max-width: 100%;
    height: auto;
  }

  .game-iframe-container img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  /* 动画增强 */
  .music-element:hover {
    animation: none !important;
  }

  .scroll-animate {
    opacity: 0;
    transform: translateY(30px);
    transition: all var(--duration-700) var(--ease-out);
  }

  .scroll-animate.animate {
    opacity: 1;
    transform: translateY(0);
  }
</style>
