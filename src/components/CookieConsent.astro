---
import { getLocaleFromLangAttr, getLocalizedPath } from '../i18n/utils';

interface Props {
  lang?: string;
}

const { lang = 'en' } = Astro.props as Props;
const locale = getLocaleFromLangAttr(lang);
const privacyHref = getLocalizedPath('/privacy/', locale);
---

<script is:inline type="module">
  const PRIVACY_HREF = {JSON.stringify(privacyHref)};

  function openConsentSettings() {
    // 优先走 IAB TCF v2（Funding Choices / 其他 CMP 通常会提供 __tcfapi）
    if (typeof window.__tcfapi === 'function') {
      try {
        window.__tcfapi('displayConsentUi', 2, () => {});
        return;
      } catch {
        // ignore
      }
    }

    // Funding Choices（尽力而为：不同版本 API 可能不同）
    const googlefc = window.googlefc;
    if (googlefc && typeof googlefc.show === 'function') {
      try {
        googlefc.show();
        return;
      } catch {
        // ignore
      }
    }

    window.location.href = PRIVACY_HREF;
  }

  // expose for footer link
  window.__fbOpenCookieConsent = openConsentSettings;

  function onDocClick(e) {
    const el = e.target instanceof Element ? e.target : null;
    if (!el) return;

    // footer/settings link
    const settingsEl = el.closest('[data-cookie-settings]');
    if (settingsEl) {
      e.preventDefault();
      openConsentSettings();
      return;
    }
  }

  // Delegation for footer “Cookie Settings”
  document.addEventListener('click', onDocClick);
</script>
