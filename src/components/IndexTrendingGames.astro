---
import OptimizedImage from './OptimizedImage.astro';
import { useTranslations, getLocaleFromLangAttr, getLocalizedPath } from '../i18n/utils';
import { getCanonicalGames, toGameCardData, type GameEntry } from '../lib/canonical-games';
import { getVoteCountFromScore } from '../lib/score';
import { seededShuffle, getTrendingSeed } from '../lib/seeded-shuffle';
import { loadTrendingItems } from '../lib/trending';
import { getFeaturedGames, getFeaturedSlugSet } from '../lib/featured';

interface Props {
  lang?: string;
}

const { lang = 'en' } = Astro.props as Props;
const locale = getLocaleFromLangAttr(lang);
const t = useTranslations(locale);

// 展示口径：这里的数量 = 最终总数（包含 featured）。
// 现网原本是 featured(3) + 非 featured(12) = 15，这里保持总量不变。
const numberOfGamesToShow = 15;
const seed = getTrendingSeed('daily');

const canonicalGames = await getCanonicalGames();
const getSlug = (entry: GameEntry): string =>
  String(entry.data.urlstr || entry.slug).replace(/^\/+/, '').replace(/\/+$/, '');

const getReleaseDateMs = (entry: GameEntry): number => (entry.data.releaseDate ? entry.data.releaseDate.getTime() : 0);

const featuredGames = getFeaturedGames(canonicalGames);
const featuredSet = getFeaturedSlugSet(featuredGames);
const nonFeaturedSlots = Math.max(0, numberOfGamesToShow - featuredGames.length);

const bySlug = new Map<string, GameEntry>();
for (const game of canonicalGames) {
  bySlug.set(getSlug(game), game);
}

const pool = canonicalGames.filter((g) => !featuredSet.has(getSlug(g)));

const trendingItems = loadTrendingItems();
const pickedSlugs = new Set<string>();
const pickedGames: GameEntry[] = [];

for (const item of trendingItems) {
  const slug = item.slug;
  if (pickedSlugs.has(slug)) continue;

  const entry = bySlug.get(slug);
  if (!entry) continue;

  pickedSlugs.add(slug);
  if (!featuredSet.has(slug)) {
    pickedGames.push(entry);
  }
  if (pickedGames.length >= nonFeaturedSlots) break;
}

const fallbackPool = pool.filter((g) => !pickedSlugs.has(getSlug(g)));

const remaining = Math.max(0, nonFeaturedSlots - pickedGames.length);
const POPULAR_POOL_SIZE = 120;
const NEW_POOL_SIZE = 120;
const POPULAR_BATCH = 3;
const NEW_BATCH = 1;

const popularCandidates = [...fallbackPool]
  .sort((a, b) => {
    const votesA = getVoteCountFromScore(a.data.score);
    const votesB = getVoteCountFromScore(b.data.score);
    const byVotes = votesB - votesA;
    if (byVotes !== 0) return byVotes;
    const byDate = getReleaseDateMs(b) - getReleaseDateMs(a);
    if (byDate !== 0) return byDate;
    return getSlug(a).localeCompare(getSlug(b));
  })
  .slice(0, POPULAR_POOL_SIZE);

const newCandidates = [...fallbackPool]
  .sort((a, b) => {
    const byDate = getReleaseDateMs(b) - getReleaseDateMs(a);
    if (byDate !== 0) return byDate;
    return getSlug(a).localeCompare(getSlug(b));
  })
  .slice(0, NEW_POOL_SIZE);

const popularShuffled = seededShuffle(popularCandidates, `${seed}:popular`);
const newShuffled = seededShuffle(newCandidates, `${seed}:new`);

const used = new Set<string>(pickedSlugs);
const mixed: GameEntry[] = [];

function tryPush(entry: GameEntry): void {
  const slug = getSlug(entry);
  if (featuredSet.has(slug)) return;
  if (used.has(slug)) return;
  used.add(slug);
  mixed.push(entry);
}

let i = 0;
let j = 0;
while (mixed.length < remaining && (i < popularShuffled.length || j < newShuffled.length)) {
  for (let k = 0; k < POPULAR_BATCH && mixed.length < remaining && i < popularShuffled.length; k++) {
    tryPush(popularShuffled[i++]!);
  }
  for (let k = 0; k < NEW_BATCH && mixed.length < remaining && j < newShuffled.length; k++) {
    tryPush(newShuffled[j++]!);
  }
}

if (mixed.length < remaining) {
  const rest = [...fallbackPool].sort((a, b) => {
    const byDate = getReleaseDateMs(b) - getReleaseDateMs(a);
    if (byDate !== 0) return byDate;
    return getSlug(a).localeCompare(getSlug(b));
  });
  for (const entry of rest) {
    if (mixed.length >= remaining) break;
    tryPush(entry);
  }
}

const fallbackGames = mixed.slice(0, remaining);
const randomGames = [...pickedGames, ...fallbackGames];

const cards = [...featuredGames, ...randomGames].map((entry) => toGameCardData(entry, locale));
---

<section class="games trending-section">
     <div class="container">
       <h2>{t('game.trendingGames', 'Trending Games')}</h2>
       <div class="game-grid game-grid--featured">
         {cards.map((card, index) => (
            <div class={`game game--compact ${index === 0 ? 'game--featured' : ''}`}>
              <a href={card.href} title={card.title}>
                 {index === 0 && (
                   <span class="game__badge">
                     <svg class="badge-icon" width="14" height="14" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                       <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                     </svg>
				     {t('game.featured', 'Featured')}
                   </span>
                 )}
                 <div class="game-logo game-l-2">
                     <OptimizedImage
                       src={card.thumbnail}
                       alt={card.title}
                       loading={index === 0 ? 'eager' : 'lazy'}
                       width={300}
                       height={169}
                     />
                 </div>
                 <p class="game__title--ellipsis">{card.title}</p>
              </a>
            </div>
         ))}
       </div>
       <div class="more"><a href={getLocalizedPath('update-games/', locale)}>{t('game.exploreGames', 'Explore Games')}</a></div>
     </div>
</section>
