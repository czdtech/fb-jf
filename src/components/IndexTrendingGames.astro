---
import { useTranslations, getLocaleFromLangAttr, getLocalizedPath } from '../i18n/utils';
import { getCanonicalGames, toGameCardData, type GameEntry } from '../lib/canonical-games';
import { seededShuffle, getTrendingSeed } from '../lib/seeded-shuffle';

interface Props {
  lang?: string;
}

const { lang = 'en' } = Astro.props as Props;
const locale = getLocaleFromLangAttr(lang);
const t = useTranslations(locale);

const numberOfGamesToShow = 12;
const seed = getTrendingSeed('daily');

const canonicalGames = await getCanonicalGames();
const getSlug = (entry: GameEntry): string =>
  String(entry.data.urlstr || entry.slug).replace(/^\/+/, '').replace(/\/+$/, '');

const featuredSlugs = ['steal-a-brainrot', '99-nights-in-the-forest', 'grow-a-garden'] as const;
const featuredSet = new Set<string>(featuredSlugs);
const isEntry = (e: GameEntry | undefined): e is GameEntry => Boolean(e);

const featuredGames = featuredSlugs
  .map((slug) => canonicalGames.find((g) => getSlug(g) === slug))
  .filter(isEntry);

const pool = canonicalGames.filter((g) => !featuredSet.has(getSlug(g)));
const randomGames = seededShuffle(pool, seed).slice(0, numberOfGamesToShow);

const cards = [...featuredGames, ...randomGames].map((entry) => toGameCardData(entry, locale));
---

<section class="games">
     <div class="container">
       <h2>{t('game.trendingGames', 'Trending Games')}</h2>
       <div class="game-grid">
         {cards.map((card) => (
            <div class="game game--compact">
              <a href={card.href} title={card.title}>
                 <div class="game-logo game-l-2">
                     <img
                       src={card.thumbnail}
                       alt={card.title}
                       loading="lazy"
                       width="300"
                       height="300"
                     />
                 </div>
                 <p class="game__title--ellipsis">{card.title}</p>
              </a>
            </div>
         ))}
       </div>
                 <div class="more"><a href={getLocalizedPath('update-games/', locale)}>{t('game.exploreGames', 'More Games')}</a></div>
            </div>
        </section>
