---
import { getCurrentLocale, LOCALE_NAMES, type SupportedLocale } from '@/i18n/utils';
import { getRelativeLocaleUrl } from 'astro:i18n';
import LanguageSelectorNative from './LanguageSelectorNative.astro'

interface Props {
  currentPath?: string
  className?: string
}

const { currentPath = '', className = '' } = Astro.props

// 使用新的i18n系统获取当前语言
const currentLocale = getCurrentLocale(Astro.url);

// 安全的获取当前页面路径（不含语言前缀）
let pathWithoutLocale = '/';
try {
  const url = new URL(Astro.request.url);
  const pathname = url.pathname || '/';
  
  // 移除语言前缀
  pathWithoutLocale = pathname.replace(/^\/(zh|es|fr|de|ja|ko)/, '') || '/';
} catch (error) {
  console.warn('Failed to parse pathname for language selector', error);
  pathWithoutLocale = '/';
}

// 语言配置使用Astro i18n helpers和新的翻译系统
const languages = Object.entries(LOCALE_NAMES).map(([code, label]) => ({
  code: code as SupportedLocale,
  label,
  path: getRelativeLocaleUrl(code as SupportedLocale, pathWithoutLocale)
}));
---

<div class={`language-selector ${className}`}>
  <LanguageSelectorNative 
    currentLang={currentLocale}
    languages={languages}
  />
</div>