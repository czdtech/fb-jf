---
import { getCanonicalGames, type GameEntry, toGameCardData } from '../lib/canonical-games';
import { useTranslations, getLocaleFromLangAttr } from '../i18n/utils';

interface Props {
  lang?: string;
}

const { lang = 'en' } = Astro.props as Props;
const locale = getLocaleFromLangAttr(lang);
const t = useTranslations(locale);

const canonicalGames = await getCanonicalGames();
const getSlug = (entry: GameEntry): string =>
  String(entry.data.urlstr || entry.slug).replace(/^\/+/, '').replace(/\/+$/, '');

const targetCount = 4;
const picked = canonicalGames
  .filter((g) => typeof g.data.sidebarPopular === 'number' && Number.isFinite(g.data.sidebarPopular))
  .sort((a, b) => (a.data.sidebarPopular! - b.data.sidebarPopular!) || getSlug(a).localeCompare(getSlug(b)))
  .slice(0, targetCount);

if (picked.length < targetCount) {
  const pickedSlugs = new Set(picked.map(getSlug));
  const fallback = canonicalGames.filter((g) => !pickedSlugs.has(getSlug(g))).slice(0, targetCount - picked.length);
  picked.push(...fallback);
}

const cards = picked.map((g) => toGameCardData(g, locale));
---

<div class="game-iframe-pop">
  <h3>&#9658; {t('game.popularGames', 'Popular Games')}</h3>
  <ul>
    {cards.map((game) => (
      <li>
        <a href={game.href} title={game.title}>
          <img src={game.thumbnail} alt={game.title} loading="lazy" width="150" height="150" />
          <div class="title">{game.title}</div>
        </a>
      </li>
    ))}
  </ul>
</div>
