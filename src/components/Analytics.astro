---
/**
 * Analytics Component
 * Contains Google Analytics (gtag.js) and Google AdSense code.
 *
 * EU/UK 合规最小集：
 * - 在用户同意前不加载第三方脚本（GA/AdSense）
 * - 同意后再动态注入脚本
 */
---

<meta name="google-adsense-account" content="ca-pub-1444054360166733">

<script is:inline>
  (function () {
    const GA_ID = 'G-9JME3P55QJ';
    const ADSENSE_CLIENT = 'ca-pub-1444054360166733';
    const CONSENT_KEY = 'fb_cookie_consent_v1';

    function getConsent() {
      try {
        return localStorage.getItem(CONSENT_KEY);
      } catch {
        return null;
      }
    }

    function setLoadedFlag(name) {
      try {
        window.__fb_loaded = window.__fb_loaded || {};
        window.__fb_loaded[name] = true;
      } catch {
        // ignore
      }
    }

    function isLoaded(name) {
      return Boolean(window.__fb_loaded && window.__fb_loaded[name]);
    }

    function injectScript(src, attrs) {
      const s = document.createElement('script');
      s.src = src;
      if (attrs) {
        for (const [k, v] of Object.entries(attrs)) {
          if (v === true) s.setAttribute(k, '');
          else if (v !== false && v != null) s.setAttribute(k, String(v));
        }
      }
      document.head.appendChild(s);
    }

    function loadGA() {
      if (isLoaded('ga')) return;
      setLoadedFlag('ga');

      // Load gtag.js first, then configure.
      injectScript(`https://www.googletagmanager.com/gtag/js?id=${encodeURIComponent(GA_ID)}`, { async: true });

      window.dataLayer = window.dataLayer || [];
      function gtag() {
        window.dataLayer.push(arguments);
      }
      window.gtag = gtag;
      gtag('js', new Date());
      gtag('config', GA_ID);
    }

    function loadAdsense() {
      if (isLoaded('adsense')) return;
      setLoadedFlag('adsense');

      injectScript(
        `https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=${encodeURIComponent(ADSENSE_CLIENT)}`,
        { async: true, crossorigin: 'anonymous' }
      );
    }

    window.__fbLoadAnalytics = loadGA;
    window.__fbLoadAdsense = loadAdsense;

    if (getConsent() === 'accepted') {
      loadGA();
      loadAdsense();
    }
  })();
</script>
