---
/**
 * Analytics Component
 * Contains Google Analytics (gtag.js) and Google AdSense code.
 *
 * 性能优化：
 * - 先初始化 Consent Mode（轻量，不阻塞）
 * - AdSense / Funding Choices 立即加载（避免 Auto Ads 不触发）
 * - GA 延后加载（首次用户交互 或 5秒后）
 */
---

<meta name="google-adsense-account" content="ca-pub-1444054360166733">

<!-- Funding Choices CMP (should be loaded early for consent flows) -->
<script async src="https://fundingchoicesmessages.google.com/i/pub-1444054360166733?ers=1"></script>

<!-- AdSense Auto Ads (must be loaded early; deferring can prevent Auto Ads from appearing) -->
<script
  async
  src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1444054360166733"
  crossorigin="anonymous"
></script>

<script is:inline>
  (function () {
    const GA_ID = 'G-9JME3P55QJ';

    // EEA + UK (GB) + CH - ISO 3166-1 alpha-2 codes
    const GDPR_REGIONS = [
      'AT','BE','BG','HR','CY','CZ','DK','EE','FI','FR','DE','GR','HU','IE','IT','LV','LT','LU','MT','NL','PL','PT','RO','SK','SI','ES','SE',
      'IS','LI','NO','GB','CH',
    ];

    // --- Minimal gtag init (required before consent calls) ---
    window.dataLayer = window.dataLayer || [];
    function gtag() { window.dataLayer.push(arguments); }
    if (typeof window.gtag !== 'function') window.gtag = gtag;

    // Consent Mode v2 defaults (this is lightweight, no blocking)
    window.gtag('consent', 'default', {
      ad_storage: 'denied',
      analytics_storage: 'denied',
      ad_user_data: 'denied',
      ad_personalization: 'denied',
      wait_for_update: 500,
      region: GDPR_REGIONS,
    });
    window.gtag('consent', 'default', {
      ad_storage: 'granted',
      analytics_storage: 'granted',
      ad_user_data: 'granted',
      ad_personalization: 'granted',
    });

    function signalGooglefcPresent() {
      try { if (window.frames && window.frames.googlefcPresent) return; } catch {}
      if (!document.body) { setTimeout(signalGooglefcPresent, 0); return; }
      var iframe = document.createElement('iframe');
      iframe.name = 'googlefcPresent';
      iframe.style.display = 'none';
      document.body.appendChild(iframe);
    }

    // Funding Choices expects an iframe named `googlefcPresent`
    signalGooglefcPresent();

    // --- Deferred loading (GA only: on first interaction OR 5s timeout) ---
    var gaLoaded = false;
    function loadGA() {
      if (gaLoaded) return;
      gaLoaded = true;
      var s = document.createElement('script');
      s.async = true;
      s.src = 'https://www.googletagmanager.com/gtag/js?id=' + encodeURIComponent(GA_ID);
      document.head.appendChild(s);
      window.gtag('js', new Date());
      window.gtag('config', GA_ID);
    }

    // Trigger on first user interaction (intentionally no mousemove - fires too easily)
    var events = ['click', 'scroll', 'keydown', 'touchstart'];
    function onInteraction() {
      events.forEach(function(e) { document.removeEventListener(e, onInteraction, { passive: true, capture: true }); });
      loadGA();
    }
    events.forEach(function(e) { document.addEventListener(e, onInteraction, { passive: true, capture: true }); });

    // Fallback: load after 1.5 seconds if no interaction
    setTimeout(loadGA, 1500);
  })();
</script>
