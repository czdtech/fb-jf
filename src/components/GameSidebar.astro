---
import OptimizedImage from './OptimizedImage.astro';
import { getCanonicalGames, type GameEntry, toGameCardData } from '../lib/canonical-games';
import { useTranslations, getLocaleFromLangAttr } from '../i18n/utils';

type SidebarKind = 'popular' | 'new';
type SidebarRankKey = 'sidebarPopular' | 'sidebarNew';

interface Props {
  lang?: string;
  kind?: SidebarKind;
}

const { lang = 'en', kind = 'popular' } = Astro.props as Props;
const locale = getLocaleFromLangAttr(lang);
const t = useTranslations(locale);

const canonicalGames = await getCanonicalGames();
const getSlug = (entry: GameEntry): string =>
  String(entry.data.urlstr || entry.slug).replace(/^\/+/, '').replace(/\/+$/, '');

const targetCount = 4;
const rankKey: SidebarRankKey = kind === 'popular' ? 'sidebarPopular' : 'sidebarNew';
const wrapperClass = kind === 'popular' ? 'game-iframe-pop' : 'game-iframe-new';
const titleKey = kind === 'popular' ? 'game.popularGames' : 'game.newGames';
const fallbackTitle = kind === 'popular' ? 'Popular Games' : 'New Games';

const picked = canonicalGames
  .filter((g) => typeof g.data[rankKey] === 'number' && Number.isFinite(g.data[rankKey]))
  .sort((a, b) => (a.data[rankKey]! - b.data[rankKey]!) || getSlug(a).localeCompare(getSlug(b)))
  .slice(0, targetCount);

if (picked.length < targetCount) {
  const pickedSlugs = new Set(picked.map(getSlug));
  const fallback = canonicalGames.filter((g) => !pickedSlugs.has(getSlug(g))).slice(0, targetCount - picked.length);
  picked.push(...fallback);
}

const cards = picked.map((g) => toGameCardData(g, locale));
---

<div class={wrapperClass}>
  <h3>&#9658; {t(titleKey, fallbackTitle)}</h3>
  <ul>
    {cards.map((game, index) => (
      <li>
        <a href={game.href} title={game.title}>
          <OptimizedImage
            src={game.thumbnail}
            alt={game.title}
            loading={index === 0 ? 'eager' : 'lazy'}
            decoding="async"
            fetchpriority={index === 0 ? 'high' : undefined}
            width={150}
            height={84}
          />
          <div class="title">{game.title}</div>
        </a>
      </li>
    ))}
  </ul>
</div>

