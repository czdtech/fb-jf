---
import GameCard from './GameCard.astro';
import CATEGORIES from './Categories.astro';
import { getCanonicalGames, type GameEntry } from '../lib/canonical-games';
import { getVoteCountFromScore } from '../lib/score';
import { seededShuffle, getTrendingSeed } from '../lib/seeded-shuffle';
import { loadTrendingItems } from '../lib/trending';
import { useTranslations, getLocaleFromLangAttr, getLocalizedPath } from '../i18n/utils';

interface Props {
  lang?: string;
}

const { lang = 'en' } = Astro.props as Props;
const locale = getLocaleFromLangAttr(lang);
const t = useTranslations(locale);

const numberOfGamesToShow = 47;

// Seed 策略：按 UTC 日期每日轮换（同一天内重复构建顺序一致）。
const seed = getTrendingSeed('daily');
const canonicalGames = await getCanonicalGames();

const getSlug = (entry: GameEntry): string =>
  String(entry.data.urlstr || entry.slug).replace(/^\/+/, '').replace(/\/+$/, '');

const getReleaseDateMs = (entry: GameEntry): number => (entry.data.releaseDate ? entry.data.releaseDate.getTime() : 0);

const getTitle = (entry: GameEntry): string => {
  const title = entry.data.title || 'Untitled';
  return title.split(' - ')[0] || title;
};

const featuredSlugs = ['steal-a-brainrot', '99-nights-in-the-forest', 'grow-a-garden'] as const;
const featuredSet = new Set<string>(featuredSlugs);
const isEntry = (e: GameEntry | undefined): e is GameEntry => Boolean(e);

const featuredGames = featuredSlugs
  .map((slug) => canonicalGames.find((g) => getSlug(g) === slug))
  .filter(isEntry);

const bySlug = new Map<string, GameEntry>();
for (const game of canonicalGames) {
  bySlug.set(getSlug(game), game);
}

const pool = canonicalGames.filter((g) => !featuredSet.has(getSlug(g)));

// Optional "real heat" input via `src/data/trending.json` (build-time).
// If missing/empty/invalid, we fall back to seeded shuffle to avoid empty UI.
const trendingItems = loadTrendingItems();
const pickedSlugs = new Set<string>();
const pickedGames: GameEntry[] = [];

for (const item of trendingItems) {
  const slug = item.slug;
  if (featuredSet.has(slug)) continue;
  if (pickedSlugs.has(slug)) continue;

  const entry = bySlug.get(slug);
  if (!entry) continue;

  pickedSlugs.add(slug);
  pickedGames.push(entry);
  if (pickedGames.length >= numberOfGamesToShow) break;
}

const fallbackPool = pool.filter((g) => !pickedSlugs.has(getSlug(g)));

// Fallback strategy when GA trending is missing:
// - Mix “popular” (by votes) + “new” (by releaseDate) for recency and variety.
// - Shuffle deterministically by day to avoid build-to-build randomness.
const remaining = Math.max(0, numberOfGamesToShow - pickedGames.length);
const POPULAR_POOL_SIZE = 250;
const NEW_POOL_SIZE = 250;
const POPULAR_BATCH = 3;
const NEW_BATCH = 1;

const popularCandidates = [...fallbackPool]
  .sort((a, b) => {
    const votesA = getVoteCountFromScore(a.data.score);
    const votesB = getVoteCountFromScore(b.data.score);
    const byVotes = votesB - votesA;
    if (byVotes !== 0) return byVotes;
    const byDate = getReleaseDateMs(b) - getReleaseDateMs(a);
    if (byDate !== 0) return byDate;
    return getSlug(a).localeCompare(getSlug(b));
  })
  .slice(0, POPULAR_POOL_SIZE);

const newCandidates = [...fallbackPool]
  .sort((a, b) => {
    const byDate = getReleaseDateMs(b) - getReleaseDateMs(a);
    if (byDate !== 0) return byDate;
    return getSlug(a).localeCompare(getSlug(b));
  })
  .slice(0, NEW_POOL_SIZE);

const popularShuffled = seededShuffle(popularCandidates, `${seed}:popular`);
const newShuffled = seededShuffle(newCandidates, `${seed}:new`);

const used = new Set<string>(pickedSlugs);
const mixed: GameEntry[] = [];

function tryPush(entry: GameEntry): void {
  const slug = getSlug(entry);
  if (featuredSet.has(slug)) return;
  if (used.has(slug)) return;
  used.add(slug);
  mixed.push(entry);
}

let i = 0;
let j = 0;
while (mixed.length < remaining && (i < popularShuffled.length || j < newShuffled.length)) {
  for (let k = 0; k < POPULAR_BATCH && mixed.length < remaining && i < popularShuffled.length; k++) {
    tryPush(popularShuffled[i++]!);
  }
  for (let k = 0; k < NEW_BATCH && mixed.length < remaining && j < newShuffled.length; k++) {
    tryPush(newShuffled[j++]!);
  }
}

// Final fill (deterministic) if still short.
if (mixed.length < remaining) {
  const rest = [...fallbackPool].sort((a, b) => {
    const byDate = getReleaseDateMs(b) - getReleaseDateMs(a);
    if (byDate !== 0) return byDate;
    return getSlug(a).localeCompare(getSlug(b));
  });
  for (const entry of rest) {
    if (mixed.length >= remaining) break;
    tryPush(entry);
  }
}

const fallbackGames = mixed.slice(0, remaining);
const randomGames = [...pickedGames, ...fallbackGames];
---

<section class="games">
  <div class="container">
    <h2>{t('game.trendingGames', 'Trending Games')}</h2>
    <div class="game-grid">
      {featuredGames.map((game) => (
        <GameCard title={getTitle(game)} thumbnail={game.data.thumbnail} slug={getSlug(game)} lang={lang} />
      ))}

      {randomGames.map((game) => (
        <GameCard title={getTitle(game)} thumbnail={game.data.thumbnail} slug={getSlug(game)} lang={lang} />
      ))}
    </div>

    <div class="more">
      <a href={getLocalizedPath('update-games/', locale)}>{t('game.exploreGames', 'More Games')}</a>
    </div>
  </div>
</section>

<CATEGORIES lang={lang} />
