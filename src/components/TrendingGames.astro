---
import GameCard from './GameCard.astro';
import CATEGORIES from './Categories.astro';
import { getCanonicalGames, type GameEntry } from '../lib/canonical-games';
import { seededShuffle, getTrendingSeed } from '../lib/seeded-shuffle';
import { loadTrendingItems } from '../lib/trending';
import { useTranslations, getLocaleFromLangAttr, getLocalizedPath } from '../i18n/utils';

interface Props {
  lang?: string;
}

const { lang = 'en' } = Astro.props as Props;
const locale = getLocaleFromLangAttr(lang);
const t = useTranslations(locale);

const numberOfGamesToShow = 47;

// Seed 策略：按 UTC 日期每日轮换（同一天内重复构建顺序一致）。
const seed = getTrendingSeed('daily');
const canonicalGames = await getCanonicalGames();

const getSlug = (entry: GameEntry): string =>
  String(entry.data.urlstr || entry.slug).replace(/^\/+/, '').replace(/\/+$/, '');

const getTitle = (entry: GameEntry): string => {
  const title = entry.data.title || 'Untitled';
  return title.split(' - ')[0] || title;
};

const featuredSlugs = ['steal-a-brainrot', '99-nights-in-the-forest', 'grow-a-garden'] as const;
const featuredSet = new Set<string>(featuredSlugs);
const isEntry = (e: GameEntry | undefined): e is GameEntry => Boolean(e);

const featuredGames = featuredSlugs
  .map((slug) => canonicalGames.find((g) => getSlug(g) === slug))
  .filter(isEntry);

const bySlug = new Map<string, GameEntry>();
for (const game of canonicalGames) {
  bySlug.set(getSlug(game), game);
}

const pool = canonicalGames.filter((g) => !featuredSet.has(getSlug(g)));

// Optional "real heat" input via `src/data/trending.json` (build-time).
// If missing/empty/invalid, we fall back to seeded shuffle to avoid empty UI.
const trendingItems = loadTrendingItems();
const pickedSlugs = new Set<string>();
const pickedGames: GameEntry[] = [];

for (const item of trendingItems) {
  const slug = item.slug;
  if (featuredSet.has(slug)) continue;
  if (pickedSlugs.has(slug)) continue;

  const entry = bySlug.get(slug);
  if (!entry) continue;

  pickedSlugs.add(slug);
  pickedGames.push(entry);
  if (pickedGames.length >= numberOfGamesToShow) break;
}

const fallbackPool = pool.filter((g) => !pickedSlugs.has(getSlug(g)));
const fallbackGames = seededShuffle(fallbackPool, seed).slice(0, Math.max(0, numberOfGamesToShow - pickedGames.length));
const randomGames = [...pickedGames, ...fallbackGames];
---

<section class="games">
  <div class="container">
    <h2>{t('game.trendingGames', 'Trending Games')}</h2>
    <div class="game-grid">
      {featuredGames.map((game) => (
        <GameCard title={getTitle(game)} thumbnail={game.data.thumbnail} slug={getSlug(game)} lang={lang} />
      ))}

      {randomGames.map((game) => (
        <GameCard title={getTitle(game)} thumbnail={game.data.thumbnail} slug={getSlug(game)} lang={lang} />
      ))}
    </div>

    <div class="more">
      <a href={getLocalizedPath('update-games/', locale)}>{t('game.exploreGames', 'More Games')}</a>
    </div>
  </div>
</section>

<CATEGORIES lang={lang} />
