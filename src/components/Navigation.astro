---
import type { NavigationItem, Language } from '@/types';
import { Button } from '@/components/ui/button';
import LanguageSelector from './LanguageSelector.astro';

export interface Props {
  navigation: NavigationItem[];
  languages: Language[];
  currentLang?: string;
  currentPath?: string;
}

const { navigation, languages, currentLang = 'en', currentPath = '/' } = Astro.props;
---

<header class="sticky top-0 z-50 w-full border-b bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/60">
  <div class="container flex h-16 items-center">
    <!-- Logo -->
    <a href="/" class="mr-6 flex items-center space-x-2">
      <span class="text-xl font-bold text-primary">FiddleBops</span>
    </a>
    
    <!-- Desktop Navigation using shadcn/ui NavigationMenu -->
    <div class="hidden md:flex">
      <nav class="flex items-center space-x-1">
        {navigation.map((item) => (
          <a 
            href={item.url} 
            class={`inline-flex h-10 w-max items-center justify-center rounded-md px-4 py-2 text-sm font-medium transition-colors hover:bg-accent hover:text-accent-foreground focus:bg-accent focus:text-accent-foreground focus:outline-none disabled:pointer-events-none disabled:opacity-50 ${
              currentPath === item.url 
                ? 'bg-accent text-accent-foreground font-semibold' 
                : 'text-muted-foreground'
            }`}
          >
            {item.label}
          </a>
        ))}
      </nav>
    </div>

    <div class="flex flex-1 items-center justify-end space-x-4">
      <!-- Desktop Language Selector -->
      <div class="hidden md:flex">
        <LanguageSelector currentPath={currentPath} />
      </div>

      <!-- Mobile Menu Toggle -->
      <Button
        variant="ghost"
        size="icon"
        class="md:hidden"
        id="mobileMenuTrigger"
        aria-label="Toggle Navigation"
        aria-expanded="false"
      >
        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
        </svg>
      </Button>
    </div>
  </div>
</header>

<!-- Mobile Navigation Sheet using shadcn/ui Sheet -->
<div 
  id="mobileSheet"
  class="fixed inset-0 z-50 hidden opacity-0 pointer-events-none"
  role="dialog"
  aria-modal="true"
  aria-labelledby="mobile-menu-title"
  data-state="closed"
  style="display: none !important;"
>
  <!-- Overlay -->
  <div 
    id="mobileOverlay"
    class="fixed inset-0 z-50 bg-black/80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 opacity-0"
    data-state="closed"
    style="display: none !important;"
  ></div>
  
  <!-- Sheet Content -->
  <div 
    id="mobileContent"
    class="fixed z-50 gap-4 bg-background p-6 shadow-lg transition ease-in-out data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:duration-300 data-[state=open]:duration-500 inset-y-0 left-0 h-full w-3/4 border-r data-[state=closed]:slide-out-to-left data-[state=open]:slide-in-from-left sm:max-w-sm opacity-0 transform -translate-x-full"
    data-state="closed"
    style="display: none !important;"
  >
    <!-- Close Button -->
    <button 
      id="mobileCloseButton"
      class="absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-secondary"
    >
      <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
      </svg>
      <span class="sr-only">Close</span>
    </button>

    <!-- Mobile Navigation Content -->
    <div class="flex flex-col space-y-6 mt-8">
      <!-- Navigation Section -->
      <div>
        <h2 id="mobile-menu-title" class="text-lg font-semibold text-foreground mb-4">Navigation</h2>
        <nav class="flex flex-col space-y-3">
          {navigation.map((item) => (
            <a 
              href={item.url}
              class={`flex items-center space-x-3 rounded-md px-3 py-2 text-sm font-medium transition-colors hover:bg-accent hover:text-accent-foreground ${
                currentPath === item.url 
                  ? 'bg-accent text-accent-foreground font-semibold' 
                  : 'text-muted-foreground'
              }`}
            >
              <span class="text-lg">ðŸŽµ</span>
              <span>{item.label}</span>
            </a>
          ))}
        </nav>
      </div>

      <!-- Language Section -->
      <div>
        <h3 class="text-lg font-semibold text-foreground mb-4">Language</h3>
        <div class="flex justify-center">
          <LanguageSelector currentPath={currentPath} className="w-full" />
        </div>
      </div>
    </div>
  </div>
</div>



<script>
// å¼ºåˆ¶ç¡®ä¿èœå•åœ¨é¡µé¢åŠ è½½æ—¶å®Œå…¨éšè—
document.addEventListener('DOMContentLoaded', () => {
  const mobileSheet = document.getElementById('mobileSheet');
  const mobileOverlay = document.getElementById('mobileOverlay');
  const mobileContent = document.getElementById('mobileContent');
  const mobileMenuTrigger = document.getElementById('mobileMenuTrigger');
  const mobileCloseButton = document.getElementById('mobileCloseButton');
  const body = document.body;

  // å¼ºåˆ¶éšè—æ‰€æœ‰èœå•å…ƒç´ 
  function forceHideMenu() {
    if (mobileSheet) {
      mobileSheet.style.display = 'none';
      mobileSheet.style.visibility = 'hidden';
      mobileSheet.style.opacity = '0';
      mobileSheet.classList.add('hidden');
      mobileSheet.setAttribute('data-state', 'closed');
    }
    if (mobileOverlay) {
      mobileOverlay.style.display = 'none';
      mobileOverlay.style.opacity = '0';
      mobileOverlay.setAttribute('data-state', 'closed');
    }
    if (mobileContent) {
      mobileContent.style.display = 'none';
      mobileContent.style.opacity = '0';
      mobileContent.style.transform = 'translateX(-100%)';
      mobileContent.setAttribute('data-state', 'closed');
    }
    if (mobileMenuTrigger) {
      mobileMenuTrigger.setAttribute('aria-expanded', 'false');
    }
    body.style.overflow = '';
  }

  // é¡µé¢åŠ è½½æ—¶ç«‹å³éšè—èœå•
  forceHideMenu();

  function openMobileMenu() {
    if (mobileSheet && mobileContent && mobileOverlay) {
      mobileSheet.style.display = 'block';
      mobileSheet.style.visibility = 'visible';
      mobileSheet.style.opacity = '1';
      mobileSheet.classList.remove('hidden');
      
      mobileOverlay.style.display = 'block';
      mobileOverlay.style.opacity = '1';
      mobileOverlay.setAttribute('data-state', 'open');
      
      mobileContent.style.display = 'block';
      mobileContent.style.opacity = '1';
      mobileContent.style.transform = 'translateX(0)';
      mobileContent.setAttribute('data-state', 'open');
      
      mobileSheet.setAttribute('data-state', 'open');
      mobileMenuTrigger.setAttribute('aria-expanded', 'true');
      body.style.overflow = 'hidden';
    }
  }

  function closeMobileMenu() {
    if (mobileSheet && mobileContent && mobileOverlay) {
      mobileContent.style.opacity = '0';
      mobileContent.style.transform = 'translateX(-100%)';
      mobileContent.setAttribute('data-state', 'closed');
      
      mobileOverlay.style.opacity = '0';
      mobileOverlay.setAttribute('data-state', 'closed');
      
      mobileMenuTrigger.setAttribute('aria-expanded', 'false');
      body.style.overflow = '';
      
      // ç­‰å¾…åŠ¨ç”»å®ŒæˆåŽéšè—
      setTimeout(() => {
        forceHideMenu();
      }, 300);
    }
  }

  // äº‹ä»¶ç›‘å¬
  if (mobileMenuTrigger) {
    mobileMenuTrigger.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      openMobileMenu();
    });
  }

  if (mobileCloseButton) {
    mobileCloseButton.addEventListener('click', closeMobileMenu);
  }

  if (mobileOverlay) {
    mobileOverlay.addEventListener('click', closeMobileMenu);
  }

  // ESCé”®å…³é—­èœå•
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      closeMobileMenu();
    }
  });

  // ç‚¹å‡»å¯¼èˆªé“¾æŽ¥å…³é—­èœå•
  const mobileNavLinks = document.querySelectorAll('#mobileContent a[href]');
  mobileNavLinks.forEach(link => {
    link.addEventListener('click', () => {
      setTimeout(closeMobileMenu, 150);
    });
  });

  // ç¡®ä¿èœå•å§‹ç»ˆå…³é—­
  setTimeout(forceHideMenu, 100);
});

// é¡µé¢å¯è§æ€§å˜åŒ–æ—¶ä¹Ÿç¡®ä¿èœå•å…³é—­
document.addEventListener('visibilitychange', () => {
  if (!document.hidden) {
    const mobileSheet = document.getElementById('mobileSheet');
    if (mobileSheet) {
      mobileSheet.style.display = 'none';
    }
  }
});
</script>