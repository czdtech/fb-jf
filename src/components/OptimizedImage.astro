---
/**
 * OptimizedImage Component
 * Uses <picture> element to serve WebP with fallback to original format
 * Supports responsive images with srcset for thumbnail directories
 * 
 * WebP files are generated by scripts/optimize-images.mjs
 */
interface Props {
  src: string;
  alt: string;
  width?: number;
  height?: number;
  loading?: 'lazy' | 'eager';
  class?: string;
  fetchpriority?: 'high' | 'low' | 'auto';
  decoding?: 'async' | 'sync' | 'auto';
  sizes?: string;
}

const { 
  src, 
  alt, 
  width, 
  height, 
  loading = 'lazy',
  class: className,
  fetchpriority,
  decoding = 'async',
  sizes,
} = Astro.props;

// Responsive sizes available (generated by optimize-images.mjs)
// Keep this small and stable: fewer variants, fewer requests, fewer surprises.
const RESPONSIVE_WIDTHS = [150, 300];

// Check if path is in a directory that has responsive images
const hasResponsiveSizes = (path: string): boolean => {
  // Only thumbnails are generated with responsive variants.
  // Character icons are already small and shouldn't trigger extra variant requests.
  return path.includes('/new-images/thumbnails/');
};

// Generate WebP path from original path
const getWebPPath = (originalPath: string): string | null => {
  if (!originalPath.startsWith('/')) return null;
  if (originalPath.startsWith('http://') || originalPath.startsWith('https://')) return null;
  
  const webpPath = originalPath.replace(/\.(png|jpe?g)$/i, '.webp');
  if (webpPath === originalPath) return null;
  
  return webpPath;
};

// Generate responsive srcset for WebP
const getResponsiveSrcset = (originalPath: string): string | null => {
  if (!hasResponsiveSizes(originalPath)) return null;
  
  const basePath = originalPath.replace(/\.(png|jpe?g)$/i, '');
  const srcsetParts = RESPONSIVE_WIDTHS.map(w => `${basePath}-${w}w.webp ${w}w`);
  
  return srcsetParts.join(', ');
};

const webpSrc = getWebPPath(src);
const isOptimizable = webpSrc !== null;
const responsiveSrcset = isOptimizable ? getResponsiveSrcset(src) : null;

// Default sizes attribute for responsive images
const defaultSizes = '(max-width: 480px) 150px, 300px';
const sizesAttr = sizes || (responsiveSrcset ? defaultSizes : undefined);

// Get MIME type for source element
const getMimeType = (path: string): string => {
  if (path.endsWith('.webp')) return 'image/webp';
  if (path.endsWith('.png')) return 'image/png';
  if (path.endsWith('.jpg') || path.endsWith('.jpeg')) return 'image/jpeg';
  return 'image/png';
};

const originalMime = getMimeType(src);
---

{isOptimizable ? (
  <picture>
    {responsiveSrcset ? (
      <source srcset={responsiveSrcset} sizes={sizesAttr} type="image/webp" />
    ) : (
      <source srcset={webpSrc} type="image/webp" />
    )}
    <source srcset={src} type={originalMime} />
    <img 
      src={src}
      alt={alt}
      width={width}
      height={height}
      loading={loading}
      class={className}
      fetchpriority={fetchpriority}
      decoding={decoding}
    />
  </picture>
) : (
  <img 
    src={src}
    alt={alt}
    width={width}
    height={height}
    loading={loading}
    class={className}
    fetchpriority={fetchpriority}
    decoding={decoding}
  />
)}
