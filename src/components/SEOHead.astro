---
/**
 * SEOHead Component
 * Renders all SEO-related meta tags in a consistent format
 * Output format matches existing pages exactly for SEO preservation
 * 
 * Uses relative paths internally, resolves to absolute URLs for meta tags (Requirements: 7.3)
 */
import { getLocaleFromLangAttr, type Locale } from '../i18n/routing';
interface Props {
  title: string;
  description: string;
  canonicalUrl: string;
  keywords?: string;
  lang?: string;
  ogImage?: string;
  ogType?: string;
  ogUrl?: string;
  twitterCard?: string;
  twitterSiteUrl?: string;
  jsonLd?: object;
  hreflangLinks?: Array<{lang: string; url: string}>;
  noindex?: boolean;
}

// Default image path (relative)
const DEFAULT_OG_IMAGE = '/tw.jpg';

const {
  title,
  description,
  canonicalUrl,
  keywords,
  lang = 'en',
  ogImage = DEFAULT_OG_IMAGE,
  ogType = 'website',
  twitterCard = 'summary_large_image',
  ogUrl,
  twitterSiteUrl,
  jsonLd,
  hreflangLinks = [],
  noindex = false
} = Astro.props;

// Resolve relative image paths to absolute URLs for social media meta tags
// Social media crawlers require absolute URLs
const resolveImageUrl = (imagePath: string): string => {
  // If already absolute URL, return as-is
  if (imagePath.startsWith('http://') || imagePath.startsWith('https://')) {
    return imagePath;
  }
  // Resolve relative path using site config
  const siteUrl = Astro.site?.toString().replace(/\/$/, '') || 'https://www.playfiddlebops.com';
  const cleanPath = imagePath.startsWith('/') ? imagePath : `/${imagePath}`;
  return `${siteUrl}${cleanPath}`;
};

const resolvedOgImage = resolveImageUrl(ogImage);
const resolvedOgUrl = ogUrl ?? canonicalUrl;
const resolvedTwitterSite = twitterSiteUrl ?? canonicalUrl;

function getOgLocaleFromLangAttr(langAttr: string): string {
  const locale: Locale = getLocaleFromLangAttr(langAttr);
  switch (locale) {
    case 'zh':
      return 'zh_CN';
    case 'de':
      return 'de_DE';
    case 'fr':
      return 'fr_FR';
    case 'es':
      return 'es_ES';
    case 'ja':
      return 'ja_JP';
    case 'ko':
      return 'ko_KR';
    case 'en':
    default:
      return 'en_US';
  }
}

const ogLocale = getOgLocaleFromLangAttr(lang);
---

<title>{title}</title>
{keywords && <meta name="keywords" content={keywords} />}
<meta name="description" content={description} />
<meta name="robots" content={noindex ? 'noindex, follow' : 'index, follow'} />

<link rel="canonical" href={canonicalUrl} />

{jsonLd && (
  <script type="application/ld+json" set:html={JSON.stringify(jsonLd)} />
)}

<meta property="og:title" content={title} />
<meta property="og:description" content={description} />
<meta property="og:url" content={resolvedOgUrl} />
<meta property="og:site_name" content="FiddleBops" />
<meta property="og:locale" content={ogLocale} />
<meta property="og:image" content={resolvedOgImage} />
<meta property="og:type" content={ogType} />

<meta name="twitter:card" content={twitterCard} />
<meta name="twitter:site" content={resolvedTwitterSite} />
<meta name="twitter:title" content={title} />
<meta name="twitter:description" content={description} />
<meta name="twitter:image" content={resolvedOgImage} />

{hreflangLinks.map(link => (
  <link rel="alternate" hreflang={link.lang} href={link.url} />
))}
