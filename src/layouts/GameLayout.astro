---
/**
 * GameLayout Component
 * Layout for Content Collection game pages ([gameSlug].astro)
 * 
 * Uses SEOHead, BaseHead, Analytics components
 * Maintains identical HTML output to existing pages for SEO preservation
 * 
 * Requirements: 2.1, 2.2, 2.3, 2.4, 4.5
 */
import SEOHead from '../components/SEOHead.astro';
import BaseHead from '../components/BaseHead.astro';
import Analytics from '../components/Analytics.astro';
import Footer from '../components/Footer.astro';
import StarRating from '../components/StarRating.astro';
import CookieConsent from '../components/CookieConsent.astro';
import ShareButtons from '../components/ShareButtons.astro';

// Import existing page components (maintain backward compatibility)
import Header from '../components/Header.astro';
import Icon from '../components/Icon.astro';
import GameSidebar from '../components/GameSidebar.astro';
import TrendingGames from '../components/TrendingGames.astro';
import { useTranslations, getLocaleFromLangAttr, getLocalizedPath } from '../i18n/utils';
import { buildGameSeoTitle, stripEmoji } from '../lib/seo-title';

interface Props {
  // Game meta
  title: string;
  seoTitle?: string;
  description: string;
  canonicalUrl: string;
  thumbnail: string;
  iframeSrc: string;
  score?: string;
  tags?: string[];
  lang?: string;
  hasFullscreen?: boolean;
  hreflangLinks?: Array<{ lang: string; url: string }>;
  ogUrl?: string;
  twitterSiteUrl?: string;
  /** Legacy slug used in URLs, e.g. "grow-a-garden" */
  slug?: string;
}

const { 
  title, 
  seoTitle,
  description, 
  canonicalUrl, 
  thumbnail, 
  iframeSrc, 
  score,
  tags,
  lang = 'en',
  hasFullscreen = true,
  hreflangLinks = [],
  slug,
  ogUrl,
  twitterSiteUrl
} = Astro.props;

const locale = getLocaleFromLangAttr(lang);
const t = useTranslations(locale);
const homeHref = getLocalizedPath('/', locale);

const pageTitle = seoTitle ? stripEmoji(seoTitle) : buildGameSeoTitle(locale, title);

// Build keywords from tags (SEO best practice) or fallback to title
// Legacy pages used curated keywords like "Sprunki Retake, Sprunki Retake online"
const keywords = tags && tags.length > 0 ? tags.join(', ') : title;

// Generate JSON-LD structured data matching existing format
const jsonLd = {
  "@context": "https://schema.org",
  "@type": "Game",
  "name": title,
  "alternateName": "playfiddlebops.com",
  "url": canonicalUrl,
  "description": description
};

---

<!DOCTYPE html>
<html lang={lang}>
<head>
    <BaseHead />
    <SEOHead
      title={pageTitle}
      description={description}
      canonicalUrl={canonicalUrl}
      keywords={keywords}
      lang={lang}
      ogImage={thumbnail}
      ogUrl={ogUrl}
      twitterSiteUrl={twitterSiteUrl}
      hreflangLinks={hreflangLinks}
      jsonLd={jsonLd}
    />
    {thumbnail && <link rel="preload" as="image" href={thumbnail} />}
    <link rel="stylesheet" href="/styles/components.css">
    <!-- Note: homepage.css contains shared layout styles (game-card, sidebars, etc.) used by both homepage and game pages -->
    <link rel="stylesheet" href="/styles/homepage.css">
    <Analytics />
</head>
<body>
<Header lang={lang}/>

    <main data-pagefind-body>
        <section class="hero">
	            <div class="container">
	                <h1 class="game-page-title">{title}</h1>
	                <div class="game-card">
	                    <div class="game-info" id="paly">
	                    </div>
	<GameSidebar lang={lang} kind="popular" />
	                   <div class="game-iframe-sprunki" style={`--bg-image: url(${thumbnail})`} >
	                    {hasFullscreen && (
	                      <button id="fullscreen-btn" title="Toggle Fullscreen" data-expanded="false">
	                          <Icon name="expand" size={20} />
	                      </button>
                    )}
                    <iframe id="fiddlebops-iframe" src="about:blank" allowtransparency="true" frameborder="0" scrolling="no" allowfullscreen width="800" height="450" loading="lazy"></iframe>
	                        <a id="playButton" href={iframeSrc} target="_blank" rel="noopener noreferrer">
	                          {t('game.play', 'Play')}
	                        </a>
	                    </div>
	<GameSidebar lang={lang} kind="new" />
	                </div>
	            </div>
	        </section>

<TrendingGames lang={lang} />

	          <section class="about" id="about">
	            <div class="container">
	              <h2>{t('game.about', 'About')} {title} </h2>
              <div class="about-content">
                  <p><a href={homeHref}>{t('common.home', 'home')}</a> > {title}</p>
                  <StarRating rating={4} maxStars={5} score={score} size={16} />

<slot />
                 </div>
            </div>
	        </section>

	    </main>

    <Footer lang={lang} />
    <CookieConsent lang={lang} />
    <ShareButtons url={canonicalUrl} title={title} lang={lang} />

<!-- Store iframe config as data attributes for the module to read -->
<div id="game-config" 
     data-iframe-src={iframeSrc} 
     data-has-fullscreen={hasFullscreen.toString()}
     data-game-slug={slug}>
</div>

<script>
  import { initFullscreen, showFullscreenButton } from '../scripts/index.ts';
  
  document.addEventListener('DOMContentLoaded', () => {
    // Read config from data attributes
    const configEl = document.getElementById('game-config');
    if (!configEl) return;
    
    const iframeSrc = configEl.dataset.iframeSrc || '';
    const hasFullscreen = configEl.dataset.hasFullscreen === 'true';
    const gameSlug = configEl.dataset.gameSlug || '';

	    // UX: Promote "Controls / How to Play" into a visually distinct card without
	    // requiring per-game content edits. Keep it dumb and predictable.
	    // Idempotent: will not wrap again if card already exists.
	    function wrapHeadingBlockAsCard(root, headingMatcher, className) {
	      if (!root) return false;
	      
	      // Idempotency: check if already wrapped
	      if (root.querySelector('.' + className)) return false;
	      
	      const headings = Array.from(root.querySelectorAll('h1,h2,h3,h4,h5,h6'));
	      const target = headings.find((h) => headingMatcher(String(h.textContent || '')));
	      if (!target) return false;

      const parent = target.parentNode;
      if (!parent) return false;

      const card = document.createElement('section');
      card.className = className;
      parent.insertBefore(card, target);

	      let node = target;
	      while (node) {
	        const next = node.nextSibling;
	        card.appendChild(node);
	        if (next && next.nodeType === 1) {
	          if (/^H[1-6]$/.test(next.tagName)) break;
	        }
	        node = next;
	      }
	      return true;
	    }

    const aboutContent = document.querySelector('#about .about-content');
    const KEYWORDS = [
      'controls',
      'control',
      'how to play',
      'how-to-play',
      '操作',
      '控制',
      '玩法',
      '怎么玩',
      '遊び方',
      '操作方法',
      '조작',
      '컨트롤',
      'controles',
      'comment jouer',
      'steuerung',
    ];
    const matchControlsHeading = (txt) => {
      const s = String(txt || '').trim().toLowerCase();
      return KEYWORDS.some((k) => s.includes(String(k).toLowerCase()));
    };
    wrapHeadingBlockAsCard(aboutContent, matchControlsHeading, 'controls-card');
    
    // Initialize iframe loader with fullscreen support
    const iframe = document.getElementById('fiddlebops-iframe');
    const playButton = document.getElementById('playButton');
    const gameContainer = document.querySelector('.game-iframe-sprunki');
    
    if (playButton && iframe && gameContainer && iframeSrc) {
      playButton.addEventListener('click', (e) => {
        e.preventDefault();
        // GA4: 记录 “Play” 点击（用于 Trending / 转化口径）
        const gtag = globalThis.gtag;
        if (typeof gtag === 'function') {
          gtag('event', 'play_click', {
            game_slug: gameSlug,
          });
        }

        iframe.src = iframeSrc;
        playButton.style.display = 'none';
        iframe.focus();
        gameContainer.classList.add('is-playing');
        gameContainer.style.backgroundImage = 'none';
        
        // Show fullscreen button after iframe loads
        if (hasFullscreen) {
          showFullscreenButton('fullscreen-btn');
        }
      });
    }
    
    // Initialize fullscreen functionality if enabled
    if (hasFullscreen) {
      initFullscreen({
        buttonId: 'fullscreen-btn',
        containerSelector: '.game-iframe-sprunki'
      });
    }
  });
</script>

</body>
</html>
