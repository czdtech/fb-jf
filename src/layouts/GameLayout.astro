---
/**
 * GameLayout Component
 * Layout for Content Collection game pages ([gameSlug].astro)
 * 
 * Uses SEOHead, BaseHead, Analytics components
 * Maintains identical HTML output to existing pages for SEO preservation
 * 
 * Requirements: 2.1, 2.2, 2.3, 2.4, 4.5
 */
import SEOHead from '../components/SEOHead.astro';
import BaseHead from '../components/BaseHead.astro';
import Analytics from '../components/Analytics.astro';
import Footer from '../components/Footer.astro';
import StarRating from '../components/StarRating.astro';
import CookieConsent from '../components/CookieConsent.astro';

// Import existing page components (maintain backward compatibility)
import Header from '../components/Header.astro';
import PopularGames from '../components/PopularGames.astro';
import NewGames from '../components/NewGames.astro';
import TrendingGames from '../components/TrendingGames.astro';
import { useTranslations, getLocaleFromLangAttr, getLocalizedPath } from '../i18n/utils';

interface Props {
  // Game meta
  title: string;
  description: string;
  canonicalUrl: string;
  thumbnail: string;
  iframeSrc: string;
  score?: string;
  tags?: string[];
  lang?: string;
  hasFullscreen?: boolean;
  hreflangLinks?: Array<{ lang: string; url: string }>;
  ogUrl?: string;
  twitterSiteUrl?: string;
  /** Legacy slug used in URLs, e.g. "grow-a-garden" */
  slug?: string;
}

const { 
  title, 
  description, 
  canonicalUrl, 
  thumbnail, 
  iframeSrc, 
  score,
  tags,
  lang = 'en',
  hasFullscreen = true,
  hreflangLinks = [],
  slug,
  ogUrl,
  twitterSiteUrl
} = Astro.props;

const locale = getLocaleFromLangAttr(lang);
const t = useTranslations(locale);
const homeHref = getLocalizedPath('/', locale);

// Use the title as-is from content (already includes "Play X Online" format)
const pageTitle = title;
const cardTitle = (pageTitle || '').split(' - ')[0] || pageTitle;

// Build keywords from tags (SEO best practice) or fallback to title
// Legacy pages used curated keywords like "Sprunki Retake, Sprunki Retake online"
const keywords = tags && tags.length > 0 ? tags.join(', ') : title;

// Generate JSON-LD structured data matching existing format
const jsonLd = {
  "@context": "https://schema.org",
  "@type": "Game",
  "name": pageTitle,
  "alternateName": "playfiddlebops.com",
  "url": canonicalUrl,
  "description": description
};

---

<!DOCTYPE html>
<html lang={lang}>
<head>
    <BaseHead />
    <SEOHead
      title={pageTitle}
      description={description}
      canonicalUrl={canonicalUrl}
      keywords={keywords}
      ogImage={thumbnail}
      ogUrl={ogUrl}
      twitterSiteUrl={twitterSiteUrl}
      hreflangLinks={hreflangLinks}
      jsonLd={jsonLd}
    />
    {thumbnail && <link rel="preload" as="image" href={thumbnail} />}
    <link rel="stylesheet" href="/styles/components.css">
    <Analytics />
</head>
<body>
<Header lang={lang}/>

    <main data-pagefind-body>
        <section class="hero">
            <div class="container">
                <div class="game-card">
                    <div class="game-info" id="paly">
                    </div>
<PopularGames lang={lang} />
                   <div class="game-iframe-sprunki" style={`--bg-image: url(${thumbnail})`} >
                    {hasFullscreen && (
                      <button id="fullscreen-btn" title="Toggle Fullscreen">
                          <i class="fa-solid fa-expand"></i>
                      </button>
                    )}
                    <iframe id="fiddlebops-iframe" src="about:blank" allowtransparency="true" frameborder="0" scrolling="no" allowfullscreen width="100%" height="100%"></iframe>
                        <a id="playButton" href={iframeSrc} target="_blank" rel="noopener noreferrer">
                          {t('game.play', 'Play')}
                        </a>
                    </div>
<NewGames lang={lang} />
                </div>
            </div>
        </section>
<TrendingGames lang={lang} />
          <section class="about" id="about">
            <div class="container">
              <h2>{t('game.about', 'About')} {title} </h2>
              <div class="about-content">
                  <p><a href={homeHref}>{t('common.home', 'home')}</a> > {title}</p>
                  <StarRating rating={4} maxStars={5} score={score} size={16} />

<slot />
                 </div>
            </div>
        </section>


    </main>

    <Footer lang={lang} />
    <CookieConsent lang={lang} />
<div class="a2a_kit a2a_kit_size_32 a2a_floating_style a2a_default_style" data-a2a-scroll-show="0,60">

<a class="a2a_button_x"></a>
<a class="a2a_button_reddit"></a>
<a class="a2a_button_facebook"></a>
<a class="a2a_button_telegram"></a>
<a class="a2a_button_whatsapp"></a>
<a class="a2a_button_linkedin"></a>
    <a class="a2a_dd" href="/"></a>
</div>

<!-- Store iframe config as data attributes for the module to read -->
<div id="game-config" 
     data-iframe-src={iframeSrc} 
     data-has-fullscreen={hasFullscreen.toString()}
     data-game-slug={slug}
     data-game-title={cardTitle}
     data-game-thumbnail={thumbnail}>
</div>

<script>
  import { initFullscreen, showFullscreenButton } from '../scripts/index.ts';
  
  document.addEventListener('DOMContentLoaded', () => {
    // Read config from data attributes
    const configEl = document.getElementById('game-config');
    if (!configEl) return;
    
    const iframeSrc = configEl.dataset.iframeSrc || '';
    const hasFullscreen = configEl.dataset.hasFullscreen === 'true';
    const gameSlug = configEl.dataset.gameSlug || '';
    const gameTitle = configEl.dataset.gameTitle || '';
    const gameThumbnail = configEl.dataset.gameThumbnail || '';

    const RECENT_KEY = 'fb_recent_games_v1';
    function recordRecentGame() {
      try {
        if (!gameSlug || !gameThumbnail) return;

        const raw = localStorage.getItem(RECENT_KEY);
        const parsed = raw ? JSON.parse(raw) : [];
        const list = Array.isArray(parsed) ? parsed : [];

        const next = list
          .filter((it) => it && typeof it === 'object' && String(it.slug || '') !== String(gameSlug))
          .slice(0, 50);

        next.unshift({
          slug: String(gameSlug),
          title: String(gameTitle || ''),
          thumbnail: String(gameThumbnail),
          playedAt: Date.now(),
        });

        localStorage.setItem(RECENT_KEY, JSON.stringify(next.slice(0, 20)));
      } catch {
        // ignore storage errors
      }
    }
    
    // Initialize iframe loader with fullscreen support
    const iframe = document.getElementById('fiddlebops-iframe');
    const playButton = document.getElementById('playButton');
    const gameContainer = document.querySelector('.game-iframe-sprunki');
    
    if (playButton && iframe && gameContainer && iframeSrc) {
      playButton.addEventListener('click', (e) => {
        e.preventDefault();
        // GA4: 记录 “Play” 点击（用于 Trending / 转化口径）
        const gtag = globalThis.gtag;
        if (typeof gtag === 'function') {
          gtag('event', 'play_click', {
            game_slug: gameSlug,
          });
        }

        // Local: 记录“最近玩”（不登录、无后端）
        recordRecentGame();

        iframe.src = iframeSrc;
        playButton.style.display = 'none';
        iframe.focus();
        gameContainer.classList.add('is-playing');
        gameContainer.style.backgroundImage = 'none';
        
        // Show fullscreen button after iframe loads
        if (hasFullscreen) {
          showFullscreenButton('fullscreen-btn');
        }
      });
    }
    
    // Initialize fullscreen functionality if enabled
    if (hasFullscreen) {
      initFullscreen({
        buttonId: 'fullscreen-btn',
        containerSelector: '.game-iframe-sprunki'
      });
    }
  });
</script>
<!-- AddToAny BEGIN -->
<div class="a2a_kit a2a_kit_size_32 a2a_floating_style a2a_vertical_style">
<a class="a2a_button_x"></a>
<a class="a2a_button_reddit"></a>
<a class="a2a_button_facebook"></a>
<a class="a2a_button_telegram"></a>
<a class="a2a_button_whatsapp"></a>
<a class="a2a_button_linkedin"></a>
    <a class="a2a_dd" href="/"></a>
</div>

<script defer src="https://static.addtoany.com/menu/page.js"></script>

</body>
</html>
