---
import BaseLayout from './BaseLayout.astro'
import Header from '@/components/Header.astro'
import Footer from '@/components/Footer.astro'
import GameRating from '@/components/GameRating.astro'

// 导入新的游戏页面Section组件
import GameHeroSection from '@/components/sections/GameHeroSection.astro'
import GameMainSection from '@/components/sections/GameMainSection.astro'
import GameFeaturesSection from '@/components/sections/GameFeaturesSection.astro'
import GameHowToPlaySection from '@/components/sections/GameHowToPlaySection.astro'
import GameRelatedSection from '@/components/sections/GameRelatedSection.astro'

// 导入数据
import extractedData from '@/data/extracted-data.json'

const { navigation, games } = extractedData

export interface Props {
  meta: {
    title: string
    description: string
    keywords?: string
    canonical: string
    ogImage: string
  }
  gameData: {
    id: string
    slug: string
    title: string
    description: string
    iframe: string
    backgroundImage: string
    category: string
    rating?: {
      score: number
      maxScore: number
      votes: number
      stars: number
    }
    features?: string[]
    howToPlay?: string[]
  }
  gameContent?: any
  breadcrumb?: {
    home: string
    current: string
  }
  pageType?: string
  isDemo?: boolean
  schemaData?: any
}

const {
  meta,
  gameData,
  gameContent,
  breadcrumb,
  pageType,
  isDemo,
  schemaData,
} = Astro.props

// 多语言配置
const hreflangLinks = navigation.languages.map(lang => ({
  code: lang.code === 'en' ? 'x-default' : lang.code,
  url:
    meta.canonical.replace('https://www.playfiddlebops.com', '') +
    (lang.code !== 'en' ? lang.url.replace('/', '') + '/' : ''),
  label: lang.label,
}))

// 增强的结构化数据，使用来自games-extended.json的schema数据
const structuredData = schemaData
  ? {
      '@context': 'https://schema.org',
      '@type': 'Game',
      ...schemaData,
      // 添加评分信息到结构化数据
      ...(gameData.rating && {
        aggregateRating: {
          '@type': 'AggregateRating',
          ratingValue: gameData.rating.score,
          bestRating: gameData.rating.maxScore,
          ratingCount: gameData.rating.votes,
        },
      }),
    }
  : {
      '@context': 'https://schema.org',
      '@type': 'Game',
      name: gameData.title,
      alternateName: 'playfiddlebops.com',
      url: meta.canonical,
      description: meta.description,
      ...(gameData.rating && {
        aggregateRating: {
          '@type': 'AggregateRating',
          ratingValue: gameData.rating.score,
          bestRating: gameData.rating.maxScore,
          ratingCount: gameData.rating.votes,
        },
      }),
    }

// 从URL中提取当前游戏的slug
const currentGameSlug = gameData.slug

// 提取所有内容数据 - 确保使用所有字段
const introductionContent = gameContent?.introduction
const featuresContent = gameContent?.features
const gameplayContent = gameContent?.gameplay
const otherContent = gameContent?.other
const accessibilityContent = gameContent?.accessibility
const advantagesContent = gameContent?.advantages
const conclusionContent = gameContent?.conclusion

// 收集所有可用的内容章节
const contentSections = [
  { key: 'introduction', data: introductionContent, priority: 1 },
  { key: 'features', data: featuresContent, priority: 2 },
  { key: 'gameplay', data: gameplayContent, priority: 3 },
  { key: 'other', data: otherContent, priority: 4 },
  { key: 'advantages', data: advantagesContent, priority: 5 },
  { key: 'accessibility', data: accessibilityContent, priority: 6 },
  { key: 'conclusion', data: conclusionContent, priority: 7 }
].filter(section => section.data && section.data.content && section.data.content.length > 0)
.sort((a, b) => a.priority - b.priority)
---

<BaseLayout
  meta={meta}
  hreflang={hreflangLinks}
  structuredData={structuredData}
>
  <Header
    navigation={navigation.main}
    languages={navigation.languages}
    currentLang="en"
    currentPath={meta.canonical.replace('https://www.playfiddlebops.com', '')}
  />

  <main>
    <!-- Game Hero Section: 游戏标题和介绍 -->
    <GameHeroSection
      gameData={gameData}
      navigation={navigation}
      breadcrumb={breadcrumb}
    />

    <!-- Game Main Section: 三栏布局 - 游戏主体和侧边栏 -->
    <GameMainSection gameData={gameData} games={games} />

    <!-- Game Rating Section: 详细评分显示 -->
    {
      gameData.rating && (
        <section class="game-rating-section scroll-animate">
          <div class="container">
            <div class="rating-wrapper music-element hero-music-delay-12">
              <GameRating rating={gameData.rating} variant="detailed" />
            </div>
          </div>
        </section>
      )
    }

    <!-- Game Features Section: 使用增强的特色功能显示 -->
    <GameFeaturesSection
      features={gameData.features}
      featuresContent={featuresContent}
      gameTitle={gameData.title}
    />

    <!-- How to Play Section: 游戏玩法说明 -->
    <GameHowToPlaySection
      howToPlay={gameData.howToPlay}
      gameplayContent={gameplayContent}
      gameTitle={gameData.title}
    />

    <!-- Enhanced Content Sections: 来自games-extended.json的所有详细内容 -->
    {
      contentSections.map((section, sectionIndex) => (
        <section class={`game-enhanced-content-section scroll-animate content-section-${section.key}`}>
          <div class="container">
            <div class={`content-wrapper music-element hero-music-delay-${25 + sectionIndex * 5}`}>
              <div class="content-inner hero-sidebar-effect">
                <h2 class="content-title">
                  <i class={`fas ${
                    section.key === 'introduction' ? 'fa-play-circle' :
                    section.key === 'features' ? 'fa-star' :
                    section.key === 'gameplay' ? 'fa-gamepad' :
                    section.key === 'advantages' ? 'fa-thumbs-up' :
                    section.key === 'accessibility' ? 'fa-universal-access' :
                    section.key === 'conclusion' ? 'fa-flag-checkered' :
                    'fa-info-circle'
                  }`} />
                  {section.data.title}
                </h2>
                <div class="content-body">
                  {section.data.content.map((contentItem: any, itemIndex: number) => {
                    if (contentItem.type === 'paragraph') {
                      return (
                        <div
                          class={`content-paragraph music-element hero-music-delay-${26 + sectionIndex * 5 + itemIndex}`}
                        >
                          <p>{contentItem.text}</p>
                        </div>
                      )
                    } else if (contentItem.type === 'steps') {
                      return (
                        <div
                          class={`steps-container music-element hero-music-delay-${26 + sectionIndex * 5 + itemIndex}`}
                        >
                          <h3 class="steps-title">Step-by-Step Guide:</h3>
                          {contentItem.items.map((step: any, stepIndex: number) => (
                            <div
                              class={`step-item music-element hero-music-delay-${27 + sectionIndex * 5 + itemIndex + stepIndex}`}
                            >
                              <div class="step-number">{stepIndex + 1}</div>
                              <div class="step-content">
                                <h4 class="step-title">{step.title}</h4>
                                <p class="step-description">
                                  {step.description}
                                </p>
                              </div>
                            </div>
                          ))}
                        </div>
                      )
                    } else if (contentItem.type === 'list') {
                      return (
                        <div
                          class={`enhanced-feature-list music-element hero-music-delay-${26 + sectionIndex * 5 + itemIndex}`}
                        >
                          {contentItem.items.map((item: any, listItemIndex: number) => (
                            <div
                              class={`enhanced-feature-item music-element hero-music-delay-${27 + sectionIndex * 5 + itemIndex + listItemIndex}`}
                            >
                              <div class="feature-icon">
                                <i class="fas fa-check-circle" />
                              </div>
                              <div class="feature-content">
                                <h4 class="feature-title">{item.title}</h4>
                                <p class="feature-description">
                                  {item.description}
                                </p>
                              </div>
                            </div>
                          ))}
                        </div>
                      )
                    }
                    return null
                  })}
                </div>
              </div>
            </div>
          </div>
        </section>
      ))
    }

    <!-- Related Games Section: 相关游戏推荐 -->
    <GameRelatedSection games={games} currentGameSlug={currentGameSlug} />
  </main>

  <Footer />
</BaseLayout>

<!-- 引入交互系统 -->
<script>
  import '@/scripts/interactions.js'
</script>

<style>
  /* ==========================================================================
   Game Rating Section
   ========================================================================== */

  .game-rating-section {
    padding: var(--space-8) 0;
    background: linear-gradient(
      135deg,
      rgba(255, 255, 255, 0.95),
      rgba(248, 250, 252, 0.98)
    );
  }

  .rating-wrapper {
    max-width: 600px;
    margin: 0 auto;
  }

  /* ==========================================================================
   Enhanced Content Section - 来自games-extended.json的详细内容
   ========================================================================== */

  .game-enhanced-content-section {
    padding: var(--space-12) 0;
    background: linear-gradient(
      135deg,
      rgba(255, 255, 255, 0.9),
      rgba(248, 250, 252, 0.95)
    );
  }

  /* 为不同内容区块添加不同的背景 */
  .content-section-introduction {
    background: linear-gradient(
      135deg,
      rgba(59, 130, 246, 0.05),
      rgba(147, 51, 234, 0.05)
    );
  }

  .content-section-features {
    background: linear-gradient(
      135deg,
      rgba(16, 185, 129, 0.05),
      rgba(5, 150, 105, 0.05)
    );
  }

  .content-section-gameplay {
    background: linear-gradient(
      135deg,
      rgba(245, 158, 11, 0.05),
      rgba(217, 119, 6, 0.05)
    );
  }

  .content-section-advantages {
    background: linear-gradient(
      135deg,
      rgba(239, 68, 68, 0.05),
      rgba(220, 38, 38, 0.05)
    );
  }

  .content-section-accessibility {
    background: linear-gradient(
      135deg,
      rgba(139, 92, 246, 0.05),
      rgba(124, 58, 237, 0.05)
    );
  }

  .content-section-conclusion {
    background: linear-gradient(
      135deg,
      rgba(6, 182, 212, 0.05),
      rgba(8, 145, 178, 0.05)
    );
  }

  .content-wrapper {
    max-width: 900px;
    margin: 0 auto;
  }

  .content-inner {
    padding: var(--space-8);
    border-radius: var(--border-radius-xl);
    transition: all var(--duration-300) var(--ease-in-out);
  }

  .content-inner:hover {
    transform: translateY(-2px);
    box-shadow:
      0 20px 60px rgba(0, 0, 0, 0.15),
      0 8px 24px rgba(0, 0, 0, 0.1),
      inset 0 1px 0 rgba(255, 255, 255, 0.8);
  }

  .content-title {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    font-size: var(--font-size-2xl);
    font-weight: var(--font-weight-bold);
    color: var(--color-gray-900);
    margin-bottom: var(--space-6);
    background: linear-gradient(
      135deg,
      var(--color-primary-600),
      var(--color-primary-700)
    );
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .content-title i {
    color: var(--color-primary-600);
    background: none;
    -webkit-text-fill-color: var(--color-primary-600);
  }

  .content-body {
    line-height: var(--line-height-relaxed);
    color: var(--color-gray-700);
  }

  .content-paragraph {
    margin-bottom: var(--space-6);
  }

  .content-paragraph p {
    font-size: var(--font-size-lg);
    line-height: var(--line-height-relaxed);
    color: var(--color-gray-700);
  }

  /* Steps Container - 增强样式 */
  .steps-container {
    margin: var(--space-8) 0;
  }

  .steps-title {
    font-size: var(--font-size-xl);
    font-weight: var(--font-weight-semibold);
    color: var(--color-gray-800);
    margin-bottom: var(--space-6);
    text-align: center;
  }

  .step-item {
    display: flex;
    gap: var(--space-4);
    margin-bottom: var(--space-6);
    padding: var(--space-5);
    border-radius: var(--border-radius-lg);
    background: rgba(255, 255, 255, 0.7);
    border: 1px solid rgba(var(--color-primary-500-rgb), 0.2);
    transition: all var(--duration-300) var(--ease-in-out);
  }

  .step-item:hover {
    background: rgba(255, 255, 255, 0.9);
    border-color: rgba(var(--color-primary-500-rgb), 0.3);
    transform: translateX(var(--space-2));
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
  }

  .step-number {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: linear-gradient(
      135deg,
      var(--color-primary-500),
      var(--color-primary-600)
    );
    color: white;
    font-weight: var(--font-weight-bold);
    font-size: var(--font-size-xl);
    flex-shrink: 0;
    box-shadow: 0 4px 12px rgba(147, 51, 234, 0.3);
  }

  .step-content {
    flex: 1;
  }

  .step-title {
    font-size: var(--font-size-lg);
    font-weight: var(--font-weight-semibold);
    color: var(--color-gray-800);
    margin-bottom: var(--space-2);
  }

  .step-description {
    color: var(--color-gray-600);
    line-height: var(--line-height-relaxed);
    font-size: var(--font-size-base);
  }

  /* Enhanced Feature List */
  .enhanced-feature-list {
    display: grid;
    gap: var(--space-4);
    margin: var(--space-8) 0;
  }

  .enhanced-feature-item {
    display: flex;
    gap: var(--space-4);
    padding: var(--space-5);
    border-radius: var(--border-radius-lg);
    background: rgba(255, 255, 255, 0.8);
    border-left: 4px solid var(--color-primary-500);
    transition: all var(--duration-300) var(--ease-in-out);
  }

  .enhanced-feature-item:hover {
    background: rgba(255, 255, 255, 0.95);
    transform: translateX(var(--space-2));
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
  }

  .enhanced-feature-item .feature-icon {
    color: var(--color-primary-600);
    font-size: var(--font-size-xl);
    flex-shrink: 0;
    width: 24px;
    text-align: center;
    margin-top: var(--space-1);
  }

  .enhanced-feature-item .feature-content {
    flex: 1;
  }

  .enhanced-feature-item .feature-title {
    font-size: var(--font-size-lg);
    font-weight: var(--font-weight-semibold);
    color: var(--color-gray-800);
    margin-bottom: var(--space-2);
  }

  .enhanced-feature-item .feature-description {
    color: var(--color-gray-600);
    line-height: var(--line-height-relaxed);
    font-size: var(--font-size-base);
  }

  /* 响应式设计 */
  @media (max-width: 768px) {
    .game-enhanced-content-section {
      padding: var(--space-8) 0;
    }

    .content-inner {
      padding: var(--space-6);
    }

    .content-title {
      font-size: var(--font-size-xl);
      flex-direction: column;
      text-align: center;
      gap: var(--space-2);
    }

    .step-item {
      flex-direction: column;
      text-align: center;
    }

    .step-number {
      align-self: center;
    }

    .enhanced-feature-item {
      flex-direction: column;
      text-align: center;
    }

    .enhanced-feature-item .feature-icon {
      align-self: center;
    }
  }

  /* 动画增强 */
  .content-section-introduction .content-inner {
    border-left: 4px solid var(--color-blue-500);
  }

  .content-section-features .content-inner {
    border-left: 4px solid var(--color-green-500);
  }

  .content-section-gameplay .content-inner {
    border-left: 4px solid var(--color-amber-500);
  }

  .content-section-advantages .content-inner {
    border-left: 4px solid var(--color-red-500);
  }

  .content-section-accessibility .content-inner {
    border-left: 4px solid var(--color-purple-500);
  }

  .content-section-conclusion .content-inner {
    border-left: 4px solid var(--color-cyan-500);
  }
</style>
